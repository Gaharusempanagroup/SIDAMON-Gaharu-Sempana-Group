<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SIDAMON Gaharu Sempana Group</title>
  <link rel="icon" type="image/png" href="Light Transparant.PNG">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  
  <style>
    /* ... (STYLE CSS SAMA SEPERTI ASLINYA, TIDAK ADA PERUBAHAN TAMPILAN) ... */
    :root { --primary-color: #000080; --bg-light: #f4f6f9; --text-dark: #333; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body.login-mode { overflow: hidden; position: fixed; width: 100%; }
    body { background-color: var(--bg-light); font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
    .bg-primary { background-color: var(--primary-color) !important; }
    .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
    body.data-loading #dashboard-section { pointer-events: none !important; user-select: none; cursor: wait; }
    body.data-loading #loading-overlay { display: none !important; }
    #login-section { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(-45deg, #000428, #004e92, #000080, #1cb5e0); background-size: 400% 400%; animation: gradientBG 15s ease infinite; z-index: 9999; }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .login-card { width: 100%; max-width: 420px; padding: 40px; border-radius: 20px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.18); text-align: center; }
    .login-logo { height: 90px; margin-bottom: 20px; animation: breathing 3s ease-in-out infinite; }
    @keyframes breathing { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
    .btn-login { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border: 1px solid rgba(255, 255, 255, 0.6); color: white; height: 55px; border-radius: 50px; font-weight: 600; width: 100%; }
    #dashboard-section { display: none; padding-bottom: 50px; }
    .stat-card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); color: white; height: 100%; position: relative; overflow: hidden; transition: transform 0.3s; }
    .stat-card:hover { transform: translateY(-5px); }
    .bg-gradient-primary { background: linear-gradient(45deg, var(--primary-color), #333399); }
    .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); } 
    .bg-gradient-danger { background: linear-gradient(45deg, #e74a3b, #be2617); }
    .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); }
    .skeleton { background: linear-gradient(to right, #e0e0e0 0%, #f0f0f0 50%, #e0e0e0 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; border-radius: 4px; display: inline-block; }
    .skeleton-text { height: 16px; width: 80%; margin-bottom: 5px; }
    @keyframes shimmer { 0% {background-position: -1000px 0;} 100% {background-position: 1000px 0;} }
    
    /* GANTT STYLES */
    .custom-gantt-wrapper { display: flex; flex-direction: column; overflow-x: auto; background: #fff; border: 1px solid #ddd; }
    .g-row-container { display: flex; border-bottom: 1px solid #f2f2f2; }
    .g-sticky-col { position: sticky; left: 0; background: #fff; width: 220px; flex-shrink: 0; z-index: 20; padding: 10px; border-right: 1px solid #eee; }
    .g-timeline-col { position: relative; flex-grow: 1; background: #fff; }
    .g-bar { position: absolute; height: 24px; top: 50%; transform: translateY(-50%); border-radius: 4px; cursor: pointer; }
    .bar-blue { background: #4e73df; } .bar-red { background: #e74a3b; } .bar-green { background: #1cc88a; } .bar-grey { background: #858796; }
    .month-marker { position: absolute; top: 0; height: 100%; border-left: 1px dashed #e0e0e0; font-size: 10px; padding-left: 5px; color: #888; }
    .custom-tooltip { position: fixed; display: none; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 9999; border-left: 4px solid var(--primary-color); }
    /* ... (Sisanya sama seperti asli) ... */
  </style>
</head>
<body class="login-mode">

  <div id="gantt-tooltip" class="custom-tooltip"></div>
  <div class="fab-container" id="fabAddData" style="position: fixed; bottom: 30px; right: 30px; z-index: 999; display: none;">
    <button class="btn btn-primary rounded-circle shadow" style="width: 60px; height: 60px; font-size: 24px;" onclick="openModalAdd()"><i class="bi bi-plus-lg"></i></button>
  </div>
  
  <div id="loading-overlay" style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; justify-content:center; align-items:center; z-index:9999; flex-direction:column;">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2 fw-bold text-secondary" id="loading-text">Memuat Data...</div>
  </div>

  <div id="login-section">
    <div class="login-card">
      <img src="IMG_0992.PNG" alt="Logo" class="login-logo">
      <h3 class="text-white fw-bold">SIDAMON</h3>
      <p class="text-white-50 mb-4">Sistem Database & Monitoring</p>
      <form onsubmit="handleLogin(event)">
        <div class="form-floating mb-3 text-start">
          <input type="password" class="form-control" id="passwordInput" placeholder="Password" required oninput="hideLoginError()">
          <label>Masukkan Password Akses</label>
        </div>
        <button type="submit" class="btn btn-login" id="loginBtn">MASUK DASHBOARD</button>
        <div id="login-alert" class="mt-3 text-danger bg-light rounded p-2 small" style="display:none;">
            <i class="bi bi-exclamation-triangle-fill me-1"></i>Password Salah.
        </div>
      </form>
    </div>
  </div>

  <div id="dashboard-section">
    <nav class="navbar navbar-dark bg-primary shadow-sm mb-4">
      <div class="container-fluid px-lg-5">
        <div class="d-flex align-items-center">
          <img src="IMG_0992.PNG" alt="Logo" style="height: 40px; margin-right: 15px;">
          <span class="text-white fw-bold">SIDAMON Group</span>
        </div>
        <div class="d-flex align-items-center gap-3">
           <div class="text-white text-end d-none d-md-block">
               <div id="greeting-time" class="small opacity-75"></div>
               <div id="greeting-role" class="fw-bold"></div>
           </div>
           <button class="btn btn-danger btn-sm rounded-pill" onclick="handleLogout()">Logout</button>
        </div>
      </div>
    </nav>

    <div class="container-fluid px-lg-5">
      <ul class="nav nav-pills mb-4 justify-content-center gap-2" id="pills-tab">
        <li class="nav-item" id="nav-skk"><button class="nav-link active" onclick="switchView('skk')">Sertifikat Keahlian</button></li>
        <li class="nav-item" id="nav-penugasan"><button class="nav-link" onclick="switchView('penugasan')">Waktu Penugasan</button></li>
        <li class="nav-item" id="nav-project"><button class="nav-link" onclick="switchView('project')">Master Project</button></li>
      </ul>

      <div id="view-skk" class="view-section">
        <div class="row g-3 mb-4 justify-content-center">
            <div class="col-md-4"><div class="stat-card bg-gradient-primary p-3" onclick="handleStatClick('skk','all',this)"><h3><span id="skk-total">0</span></h3><small>Total Personil</small></div></div>
            <div class="col-md-4"><div class="stat-card bg-gradient-danger p-3" onclick="handleStatClick('skk','expired',this)"><h3><span id="skk-expired">0</span></h3><small>Expired</small></div></div>
            <div class="col-md-4"><div class="stat-card bg-gradient-warning p-3" onclick="handleStatClick('skk','used',this)"><h3><span id="skk-used">0</span></h3><small>Terpakai</small></div></div>
        </div>
        <div class="d-flex justify-content-between mb-3 align-items-center">
            <input type="text" id="searchSkk" class="form-control w-50" placeholder="Cari Nama Personil...">
            <div id="btnAddDataContainer"><button class="btn btn-success rounded-pill" onclick="openModalAdd()">+ Tambah</button></div>
        </div>
        <div class="card p-3 border-0 shadow-sm">
           <div class="table-responsive">
             <table class="table table-hover align-middle">
               <thead class="table-light"><tr><th>Nama Personil</th><th>Kontak</th><th>Jenjang</th><th>Sertifikat</th><th>Status</th><th>Keterangan</th><th id="th-aksi-skk">Aksi</th></tr></thead>
               <tbody id="bodySkk"></tbody>
             </table>
           </div>
           <div id="pagination-skk" class="d-flex justify-content-center gap-1 mt-3"></div>
        </div>
      </div>

      <div id="view-penugasan" class="view-section" style="display:none;">
         <div class="row g-3 mb-4 justify-content-center">
            <div class="col-md-6"><div class="stat-card bg-gradient-primary p-3"><h3><span id="tugas-total">0</span></h3><small>Total Paket</small></div></div>
            <div class="col-md-6"><div class="stat-card bg-gradient-success p-3"><h3><span id="tugas-active">0</span></h3><small>Aktif</small></div></div>
         </div>
         <div class="mb-3 btn-group">
            <button class="btn btn-outline-primary active" onclick="switchTugasSubView('table')" id="btn-tugas-table">Tabel</button>
            <button class="btn btn-outline-primary" onclick="switchTugasSubView('gantt')" id="btn-tugas-gantt">Timeline</button>
         </div>
         <div id="subview-tugas-table">
            <input type="text" id="searchTugas" class="form-control mb-3 w-50" placeholder="Cari Penugasan...">
            <div class="card p-3 border-0 shadow-sm table-responsive">
               <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Personil</th><th>Paket Pekerjaan</th><th>Jenis</th><th>Sertifikat</th><th>Periode</th><th>Status</th></tr></thead><tbody id="bodyTugas"></tbody></table>
            </div>
            <div id="pagination-tugas" class="d-flex justify-content-center gap-1 mt-3"></div>
         </div>
         <div id="subview-tugas-gantt" style="display:none;">
            <div id="chart_penugasan" class="mt-3"></div>
         </div>
      </div>

      <div id="view-project" class="view-section" style="display:none;">
         <div class="row g-3 mb-4 justify-content-center">
            <div class="col-md-4"><div class="stat-card bg-gradient-primary p-3"><h3><span id="proj-total">0</span></h3><small>Total Project</small></div></div>
            <div class="col-md-4"><div class="stat-card bg-gradient-danger p-3"><h3><span id="proj-expired">0</span></h3><small>Expired</small></div></div>
            <div class="col-md-4"><div class="stat-card bg-gradient-success p-3"><h3><span id="proj-done">0</span></h3><small>Selesai</small></div></div>
         </div>
         <div class="mb-3 btn-group">
             <button class="btn btn-outline-primary active" onclick="switchSubView('table')" id="btn-sub-table">Tabel</button>
             <button class="btn btn-outline-primary" onclick="switchSubView('gantt-kontrak')">Gantt Kontrak</button>
             <button class="btn btn-outline-primary" onclick="switchSubView('gantt-schedule')">Gantt Schedule</button>
         </div>
         <div id="subview-table">
             <input type="text" id="searchProject" class="form-control mb-3 w-50" placeholder="Cari Project...">
             <div class="card p-3 border-0 shadow-sm table-responsive">
                <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Pekerjaan</th><th>Kordinator</th><th>Deadline</th><th>Status</th><th>Ket</th></tr></thead><tbody id="bodyProject"></tbody></table>
             </div>
             <div id="pagination-project" class="d-flex justify-content-center gap-1 mt-3"></div>
         </div>
         <div id="subview-gantt-kontrak" style="display:none;"><div id="chart_kontrak"></div></div>
         <div id="subview-gantt-schedule" style="display:none;"><div id="chart_schedule"></div></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalTambahData" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white"><h5 class="modal-title" id="modalLabel">Input Data</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
           <form id="formInputData">
             <input type="hidden" id="editRowNumber">
             <div class="mb-3"><label>Nama Personil</label><input class="form-control" list="listNama" id="inputNama" required><datalist id="listNama"></datalist></div>
             <div class="mb-3"><label>Perusahaan</label><input class="form-control" list="listPerusahaan" id="inputPerusahaan" required><datalist id="listPerusahaan"></datalist></div>
             <div class="row">
                <div class="col-md-7 mb-3"><label>Sertifikat</label>
                   <input class="form-control" list="listSertifikat" id="inputSertifikat">
                   <select class="form-select" id="selectSertifikatEdit" style="display:none;" onchange="loadSelectedCertificateData()"></select>
                   <datalist id="listSertifikat"></datalist>
                </div>
                <div class="col-md-5 mb-3"><label>Jenjang</label><input class="form-control" list="listJenjang" id="inputJenjang" required><datalist id="listJenjang"></datalist></div>
             </div>
             <div class="row">
                 <div class="col-6 mb-3"><label>Asosiasi</label><input class="form-control" id="inputAsosiasi"></div>
                 <div class="col-6 mb-3"><label>Masa Berlaku</label><input type="date" class="form-control" id="inputMasaBerlaku" required></div>
             </div>
             <div class="mb-3"><label>Keterangan</label><textarea class="form-control" id="inputKeterangan"></textarea></div>
           </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary rounded-pill" onclick="submitForm()">Simpan</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- GANTI URL INI DENGAN URL WEB APP TERBARU ANDA SETELAH DEPLOY ---
    const CONST_API_URL = "https://script.google.com/macros/s/AKfycbw5HBU0rbZ2occIJ77QlUQpt2nMAQrFu_pKdEkS0kJmK8ooi6SQQL1M0xU_3NztAqRACw/exec";
    
    const ITEMS_PER_PAGE = 20; 
    let currentPageSkk = 1, currentPageTugas = 1, currentPageProject = 1;
    let dataSKK = [], dataTugas = [], dataProject = [];
    let currentUserRole = ''; 
    let canEdit = false;
    let filterStatusSKK = 'all';

    // --- UTILS ---
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
    function toggleLoadingState(isLoading) {
        if (isLoading) { document.body.classList.add('data-loading'); } 
        else { document.body.classList.remove('data-loading'); }
    }
    
    async function fetchAPI(action, method = 'GET', data = null) {
        let url = `${CONST_API_URL}?action=${action}`;
        const options = { method: method };
        if (method === 'POST') { 
            options.headers = { "Content-Type": "text/plain;charset=utf-8" }; 
            options.body = JSON.stringify({ action: action, ...data }); 
        }
        const response = await fetch(url, options);
        if (!response.ok) throw new Error('Network error');
        return await response.json();
    }
    
    async function hashPassword(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // --- INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        const storedRole = sessionStorage.getItem('userRole');
        if (storedRole) { loginSuccess(storedRole); }
        try { google.charts.load('current', {'packages':['gantt']}); } catch(e){}
    });

    // --- LOGIN LOGIC ---
    function hideLoginError() { document.getElementById('login-alert').style.display = 'none'; }
    
    async function handleLogin(e) {
      e.preventDefault();
      const pass = document.getElementById('passwordInput').value;
      const btn = document.getElementById('loginBtn');
      btn.innerHTML = 'Memeriksa...'; btn.disabled = true; 
      
      try {
          const hashedPassword = await hashPassword(pass);
          const response = await fetchAPI('login', 'POST', { password: hashedPassword });
          if (response && response.valid) { 
              loginSuccess(response.role); 
              Toast.fire({ icon: 'success', title: 'Login Berhasil' }); 
          } else { throw new Error("Invalid"); }
      } catch (err) {
            btn.innerHTML = 'MASUK DASHBOARD'; btn.disabled = false; 
            document.getElementById('login-alert').style.display = 'block';
      }
    }

    function loginSuccess(role) {
        currentUserRole = role; 
        sessionStorage.setItem('userRole', role);
        document.getElementById('login-section').style.display = 'none'; 
        document.getElementById('dashboard-section').style.display = 'block'; 
        document.body.classList.remove('login-mode'); 
        
        applyRoleAccess(role);
        updateGreeting(role);
        loadAllData(); // CALL DATA FETCH
    }
    
    function handleLogout() {
        sessionStorage.removeItem('userRole'); window.location.reload();
    }
    
    function updateGreeting(role) {
        const h = new Date().getHours();
        document.getElementById('greeting-time').innerText = h < 11 ? "Selamat Pagi" : (h < 15 ? "Selamat Siang" : "Selamat Malam");
        document.getElementById('greeting-role').innerText = role === 'SUPER_ADMIN' ? "Super Admin" : role;
    }

    function applyRoleAccess(role) {
        const navSkk = document.getElementById('nav-skk'), navTugas = document.getElementById('nav-penugasan'), navProject = document.getElementById('nav-project');
        const btnAdd = document.getElementById('btnAddDataContainer');
        navSkk.style.display = 'block'; navTugas.style.display = 'block'; navProject.style.display = 'block';
        btnAdd.style.display = 'block'; 
        canEdit = false;

        if (role === "SUPER_ADMIN" || role === "ADMIN_INPUT") { canEdit = true; }
        if (role === "ADMIN_INPUT") { navProject.style.display = 'none'; }
        if (role === "ADMIN") { navProject.style.display = 'none'; btnAdd.style.display = 'none'; document.getElementById('th-aksi-skk').style.display = 'none'; }
        if (role === "TEKNIS") { navSkk.style.display = 'none'; navTugas.style.display = 'none'; switchView('project'); }
        else { switchView('skk'); }
    }

    // --- CORE DATA FETCH (OPTIMIZED) ---
    async function loadAllData() {
        // UI Skeleton Setup
        if(currentUserRole !== "TEKNIS") { showSkeleton('bodySkk'); showSkeleton('bodyTugas'); }
        if(currentUserRole === "SUPER_ADMIN" || currentUserRole === "TEKNIS") { showSkeleton('bodyProject'); }
        toggleLoadingState(true);

        try {
            // SINGLE REQUEST TO SERVER
            const result = await fetchAPI('getAllData'); 
            
            if (result.error) throw new Error(result.error);

            // Assign Data Global
            dataSKK = result.skk || [];
            dataTugas = result.penugasan || [];
            dataProject = result.project || [];
            const dropdownData = result.dropdown || {};

            // Render
            if (currentUserRole !== "TEKNIS") {
                renderSKK(dataSKK, 1);
                renderTugas(dataTugas, 1);
            }
            if (currentUserRole === "SUPER_ADMIN" || currentUserRole === "TEKNIS") {
                renderProject(dataProject, 1);
            }

            // Populate Dropdowns
            if (canEdit && dropdownData.nama) {
                populateDatalist('listNama', dropdownData.nama);
                populateDatalist('listPerusahaan', dropdownData.perusahaan);
                populateDatalist('listSertifikat', dropdownData.sertifikat);
                populateDatalist('listJenjang', dropdownData.jenjang);
            }

        } catch(e) { 
            console.error(e); 
            Swal.fire("Gagal Memuat Data", "Kesalahan: " + e.message, "error");
        } finally {
            toggleLoadingState(false);
        }
    }

    function showSkeleton(id) {
        document.getElementById(id).innerHTML = `<tr><td colspan="7"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text" style="width:60%"></div></td></tr>`.repeat(5);
    }

    // --- RENDER FUNCTIONS (Simplified Logic for brevity) ---
    function renderSKK(data, page) {
        currentPageSkk = page;
        const tbody = document.getElementById('bodySkk');
        let html = '';
        
        // Filter logic simple
        let filtered = data;
        const search = document.getElementById('searchSkk').value.toLowerCase();
        if(search) filtered = filtered.filter(r => (r[1]||"").toLowerCase().includes(search));
        
        // Update Stats
        document.getElementById('skk-total').innerText = filtered.length;
        
        // Paging
        const start = (page-1)*ITEMS_PER_PAGE;
        const paged = filtered.slice(start, start+ITEMS_PER_PAGE);
        
        paged.forEach(row => {
            const nama = row[1], kontak = row[2], jenjang = row[6], sertifikat = row[5], statusRaw = row[10], ket = row[11];
            let badgeClass = statusRaw.toLowerCase().includes('expired') ? 'bg-danger' : (statusRaw.toLowerCase().includes('used') ? 'bg-warning text-dark' : 'bg-success');
            
            let aksi = canEdit ? `<button class="btn btn-sm btn-outline-primary rounded-circle" onclick="openModalEditGroup('${nama}')"><i class="bi bi-pencil-fill"></i></button>` : '';
            if(!canEdit) document.getElementById('th-aksi-skk').style.display = 'none';

            html += `<tr><td><div class="fw-bold">${nama}</div><small class="text-muted">${row[4]}</small></td>
                     <td>${kontak}</td><td>${jenjang}</td><td>${sertifikat}</td>
                     <td><span class="badge ${badgeClass}">${statusRaw}</span></td>
                     <td><small>${ket}</small></td><td>${aksi}</td></tr>`;
        });
        
        tbody.innerHTML = html || '<tr><td colspan="7" class="text-center text-muted">Data Kosong</td></tr>';
        setupPagination(filtered.length, page, 'pagination-skk', (p) => renderSKK(data, p));
    }

    function renderTugas(data, page) {
        currentPageTugas = page;
        const tbody = document.getElementById('bodyTugas');
        let html = '';
        
        let filtered = data.filter(r => r[1]); // Valid rows
        const search = document.getElementById('searchTugas').value.toLowerCase();
        if(search) filtered = filtered.filter(r => (r[1]||"").toLowerCase().includes(search));

        document.getElementById('tugas-total').innerText = filtered.length;
        
        const start = (page-1)*ITEMS_PER_PAGE;
        const paged = filtered.slice(start, start+ITEMS_PER_PAGE);

        paged.forEach(row => {
            const nama = row[1], paket = row[2], jenis = row[3], sert = row[6], startD = row[9], endD = row[10], status = row[12];
            let badge = status.toLowerCase().includes('active') ? 'bg-success' : 'bg-secondary';
            html += `<tr><td>${nama}</td><td>${paket}</td><td>${jenis}</td><td>${sert}</td>
                     <td><small>${startD} - ${endD}</small></td>
                     <td><span class="badge ${badge}">${status}</span></td></tr>`;
        });
        tbody.innerHTML = html || '<tr><td colspan="6" class="text-center">Data Kosong</td></tr>';
        setupPagination(filtered.length, page, 'pagination-tugas', (p) => renderTugas(data, p));
    }

    function renderProject(data, page) {
        currentPageProject = page;
        const tbody = document.getElementById('bodyProject');
        let html = '';
        
        let filtered = data.filter(r => r[2]); 
        const search = document.getElementById('searchProject').value.toLowerCase();
        if(search) filtered = filtered.filter(r => (r[2]||"").toLowerCase().includes(search));
        
        document.getElementById('proj-total').innerText = filtered.length;

        const start = (page-1)*ITEMS_PER_PAGE;
        const paged = filtered.slice(start, start+ITEMS_PER_PAGE);

        paged.forEach(row => {
            const project = row[2], kord = row[4], deadline = row[9], status = row[16], ket = row[18];
            html += `<tr><td>${project}</td><td>${kord}</td><td>${deadline}</td>
                     <td><span class="badge bg-info">${status}</span></td><td><small>${ket}</small></td></tr>`;
        });
        tbody.innerHTML = html || '<tr><td colspan="5" class="text-center">Data Kosong</td></tr>';
        setupPagination(filtered.length, page, 'pagination-project', (p) => renderProject(data, p));
    }

    function setupPagination(total, curr, id, callback) {
        const pages = Math.ceil(total/ITEMS_PER_PAGE);
        const container = document.getElementById(id);
        container.innerHTML = '';
        if(pages <= 1) return;
        
        const createBtn = (i, text) => {
            const b = document.createElement('button');
            b.className = `btn btn-sm ${i===curr ? 'btn-primary' : 'btn-outline-primary'}`;
            b.innerText = text || i;
            b.onclick = () => callback(i);
            container.appendChild(b);
        };
        
        if(curr > 1) createBtn(curr-1, '<');
        // Simple pagination logic (show current, prev, next)
        if(curr > 2) createBtn(1);
        if(curr > 3) container.appendChild(document.createTextNode('..'));
        if(curr > 1) createBtn(curr-1);
        createBtn(curr);
        if(curr < pages) createBtn(curr+1);
        if(curr < pages - 2) container.appendChild(document.createTextNode('..'));
        if(curr < pages - 1) createBtn(pages);
        if(curr < pages) createBtn(curr+1, '>');
    }

    // --- OTHER HELPERS ---
    function populateDatalist(id, arr) {
        const dl = document.getElementById(id); dl.innerHTML = '';
        arr.forEach(t => { const op = document.createElement('option'); op.value = t; dl.appendChild(op); });
    }
    
    // --- MODAL FUNCTIONS (Simpan Data) ---
    const myModal = new bootstrap.Modal(document.getElementById('modalTambahData'));
    function openModalAdd() { document.getElementById('formInputData').reset(); myModal.show(); }
    
    async function submitForm() {
        const form = document.getElementById('formInputData');
        const nama = document.getElementById('inputNama').value;
        const perusahaan = document.getElementById('inputPerusahaan').value;
        
        if(!nama || !perusahaan) return Swal.fire('Error','Nama & Perusahaan wajib diisi','warning');
        
        myModal.hide();
        
        Swal.fire({
            title: 'Konfirmasi Password', input: 'password', showCancelButton: true, confirmButtonText: 'Simpan',
            preConfirm: async (pass) => { if(!pass) Swal.showValidationMessage('Isi password'); return await hashPassword(pass); }
        }).then(async (res) => {
            if(res.isConfirmed) {
                document.getElementById('loading-overlay').style.display = 'flex';
                
                const payload = {
                    rowNumber: document.getElementById('editRowNumber').value,
                    nama: nama,
                    perusahaan: perusahaan,
                    sertifikat: document.getElementById('inputSertifikat').value,
                    jenjang: document.getElementById('inputJenjang').value,
                    asosiasi: document.getElementById('inputAsosiasi').value,
                    masaBerlaku: document.getElementById('inputMasaBerlaku').value,
                    keterangan: document.getElementById('inputKeterangan').value
                };

                try {
                    const resp = await fetchAPI('saveData', 'POST', { password: res.value, payload: payload });
                    if(resp === "Sukses") { 
                        Toast.fire({ icon: 'success', title: 'Data Tersimpan' }); 
                        loadAllData(); // Refresh Data
                    } else { Swal.fire('Gagal', resp, 'error'); }
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
                finally { document.getElementById('loading-overlay').style.display = 'none'; }
            }
        });
    }

    // Event Listeners Search
    document.getElementById('searchSkk').addEventListener('keyup', () => renderSKK(dataSKK, 1));
    document.getElementById('searchTugas').addEventListener('keyup', () => renderTugas(dataTugas, 1));
    document.getElementById('searchProject').addEventListener('keyup', () => renderProject(dataProject, 1));

    // View Switchers
    window.switchView = function(v) {
        document.querySelectorAll('.view-section').forEach(e => e.style.display='none');
        document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+v).style.display='block';
        document.getElementById('nav-'+(v==='skk'?'skk':(v==='penugasan'?'penugasan':'project'))).querySelector('button').classList.add('active');
    };
    
    // Stub functions for subviews (implement as needed)
    window.switchTugasSubView = function(v) {
        document.getElementById('subview-tugas-table').style.display = v==='table'?'block':'none';
        document.getElementById('subview-tugas-gantt').style.display = v==='gantt'?'block':'none';
    };
    window.switchSubView = function(v) {
        document.getElementById('subview-table').style.display = v==='table'?'block':'none';
        document.getElementById('subview-gantt-kontrak').style.display = v==='gantt-kontrak'?'block':'none';
        document.getElementById('subview-gantt-schedule').style.display = v==='gantt-schedule'?'block':'none';
    };
    
    // Placeholder for Gantt Chart (Implement actual drawing logic here based on dataTugas/dataProject)
    function drawGanttChart(type) { console.log("Drawing Gantt for " + type); }
  </script>
</body>
</html>
