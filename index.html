<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <title>SIDAMON Gaharu Sempana Group</title>
  <link rel="icon" type="image/png" href="Light Transparant.PNG">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    /* --- CSS GLOBAL --- */
    :root { --primary-color: #000080; --bg-light: #f4f6f9; --text-dark: #333; }
    
    html, body { height: 100%; margin: 0; padding: 0; }
    body.login-mode { overflow: hidden; position: fixed; width: 100%; }
    body { background-color: var(--bg-light); font-family: 'Poppins', 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
    
    .bg-primary { background-color: var(--primary-color) !important; }
    .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
    .btn-primary:hover { background-color: #000060; border-color: #000060; }

    /* LOGIN PAGE */
    #login-section { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(-45deg, #000428, #004e92, #000080, #1cb5e0); background-size: 400% 400%; animation: gradientBG 15s ease infinite; z-index: 9999; padding: 20px; }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    
    .login-card { width: 100%; max-width: 420px; padding: 40px; border-radius: 20px; background: rgba(255, 255, 255, 0.15); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.18); text-align: center; animation: fadeInUp 0.8s ease-out; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes breathing { 0% { transform: scale(1); filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); } 50% { transform: scale(1.08); filter: drop-shadow(0 8px 12px rgba(0,0,0,0.4)); } 100% { transform: scale(1); filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); } }
    
    .login-logo { height: 90px; margin-bottom: 20px; animation: breathing 3s ease-in-out infinite; }
    .login-title { color: #ffffff; font-weight: 700; margin-bottom: 5px; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .login-subtitle { color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-bottom: 30px; font-weight: 300; }
    .login-footer { position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center; color: rgba(255, 255, 255, 0.5); font-size: 0.75rem; pointer-events: none; letter-spacing: 1px; font-weight: 300; }
    
    /* INPUTS */
    .form-floating > .form-control { border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.6); height: 55px; background: rgba(255, 255, 255, 0.25); color: #fff; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
    .form-floating > .form-control:focus { border-color: #fff; background: rgba(255, 255, 255, 0.35); box-shadow: 0 0 15px rgba(255, 255, 255, 0.3); outline: none; }
    .form-floating > label { color: rgba(255, 255, 255, 0.9); font-weight: 500; }
    .form-floating > .form-control:focus ~ label, .form-floating > .form-control:not(:placeholder-shown) ~ label { color: rgba(255, 255, 255, 1); font-weight: 600; opacity: 1; }
    .form-floating > .form-control:focus ~ label::after, .form-floating > .form-control:not(:placeholder-shown) ~ label::after { background-color: transparent !important; }
    
    .btn-login { background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border: 1px solid rgba(255, 255, 255, 0.6); color: white; height: 55px; border-radius: 50px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; font-size: 0.9rem; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); backdrop-filter: blur(5px); transition: all 0.4s ease; position: relative; overflow: hidden; width: 100%; cursor: pointer; }
    .btn-login:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.25); border-color: #ffffff; box-shadow: 0 0 25px rgba(255, 255, 255, 0.4); color: white !important; }
    .btn-login:disabled { opacity: 0.7; cursor: not-allowed; }
    
    .login-alert { margin-top: 15px; padding: 12px 20px; border-radius: 15px; background: rgba(220, 53, 69, 0.15); border: 1px solid rgba(220, 53, 69, 0.4); color: #ffcccc; font-size: 0.85rem; font-weight: 500; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; gap: 10px; animation: slideDownFade 0.4s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 4px 15px rgba(220, 53, 69, 0.1); }
    @keyframes slideDownFade { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
    .shake-anim { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

    /* DASHBOARD STYLES */
    #dashboard-section { padding-bottom: 50px; min-height: 100vh; }
    
    /* === LOGO WRAPPER (BERSIH TOTAL) === */
    .logo-wrapper { 
        background: transparent !important;
        padding: 0 !important;
        border: none !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
        border-radius: 0 !important;
        margin-right: 15px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
    }

    /* === ANIMASI GREETING (BERSIH TOTAL) === */
    @keyframes slideInSmooth { 
      from { opacity: 0; transform: translateY(-10px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    
    .greeting-wrapper {
      animation: slideInSmooth 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
      padding: 6px 0;
      margin-left: 15px;
      border: none !important;
      border-left: none !important;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      cursor: default;
    }

    /* Efek Hover Text Only */
    .greeting-wrapper:hover {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
        transform: translateY(-2px); 
    }

    /* Efek Hover pada Teks (Glowing) */
    .greeting-wrapper:hover #greeting-role {
        text-shadow: 0 0 12px rgba(255, 255, 255, 0.8); 
    }

    /* Efek Hover pada Ikon (Berputar & Membesar Sedikit) */
    .greeting-wrapper i {
        display: inline-block;
        transition: transform 0.5s ease;
    }
    .greeting-wrapper:hover i {
        transform: rotate(20deg) scale(1.15); 
    }
    
    /* NAV PILLS */
    .nav-pills .nav-link { border-radius: 50px; padding: 10px 25px; font-weight: 600; color: #555; background: white; border: 1px solid #ddd; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; touch-action: manipulation; }
    .nav-pills .nav-link.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 4px 15px rgba(0, 0, 128, 0.3); }
    .nav-pills .nav-link:hover:not(.active) { background-color: #f8f9fa; transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); color: var(--primary-color); }
    .btn:active, .nav-link:active { transform: scale(0.95) !important; background-color: #f0f0f0; }

    /* SUB NAV */
    .sub-nav .btn { border-radius: 20px; font-size: 0.85rem; font-weight: 600; padding: 6px 15px; border: 1px solid #ddd; background: white; color: #555; transition: all 0.2s ease; touch-action: manipulation; }
    .sub-nav .btn.active { background-color: #000080; color: white; border-color: #000080; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    
    /* STATS CARDS */
    .stats-wrapper { max-width: 1100px; margin: 0 auto; }
    .stat-card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); transition: transform 0.3s ease, box-shadow 0.3s ease; color: white; overflow: hidden; height: 100%; position: relative; z-index: 1; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2) !important; }
    .stat-card i { transition: all 0.5s ease; }
    .stat-card:hover i { transform: scale(1.2) rotate(10deg); opacity: 0.7 !important; }
    .stat-value { font-size: 2.5rem; font-weight: 700; line-height: 1; }
    .stat-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; }
    
    .bg-gradient-primary { background: linear-gradient(45deg, var(--primary-color), #333399); }
    .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); } 
    .bg-gradient-danger { background: linear-gradient(45deg, #e74a3b, #be2617); }
    .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); }

    /* TABLE & INPUTS */
    .search-input { height: 50px; border-radius: 25px; padding-left: 55px; border: 1px solid #ced4da; transition: all 0.3s; }
    .search-input:focus { box-shadow: 0 4px 15px rgba(0, 0, 128, 0.15); border-color: var(--primary-color); }
    .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #aaa; z-index: 5; font-size: 1.1rem; }
    
    .table-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: none; }
    .table thead th { background-color: #f8f9fc; color: #5a5c69; font-weight: 600; vertical-align: middle; border-bottom: 2px solid #eaecf4; }
    
    .badge-status { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; white-space: normal; text-align: left; display: inline-block; }
    .status-expired { background-color: #ffe5e5; color: #cc0000; border: 1px solid #ffcccc; }
    .status-active { background-color: #e5ffe5; color: #007700; border: 1px solid #ccffcc; }
    .status-used { background-color: #fff4e5; color: #cc7700; border: 1px solid #ffeebb; } 
    .status-not-started { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }

    /* TABLE SCROLL & FIXES */
    .table-responsive { display: block; width: 100%; overflow-x: auto !important; -webkit-overflow-scrolling: touch; margin-bottom: 10px; border: 1px solid #f0f0f0; border-radius: 8px; }
    .table th, .table td { vertical-align: middle; border-color: #f0f0f0; }
    .table th:first-child, .table td:first-child { position: static !important; z-index: auto !important; padding-left: 15px; }
    .table thead th:first-child { background-color: #f8f9fc !important; }
    .table tbody td:first-child { background-color: #fff !important; }

    .nested-cell { display: flex; align-items: center; min-height: 45px; border-bottom: 1px solid #f5f5f5; padding: 6px 0; }
    .nested-cell:last-child { border-bottom: none; }
    .nested-cell-action { justify-content: center; }
    .align-middle-person { vertical-align: middle !important; }

    /* GANTT */
    .custom-gantt-wrapper { display: flex; flex-direction: column; background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); overflow-x: auto; position: relative; max-width: 100%; }
    .g-row-container { display: flex; align-items: stretch; width: max-content; min-width: 100%; border-bottom: 1px solid #f2f2f2; position: relative; }
    .g-sticky-col { position: sticky; left: 0; z-index: 20; background-color: #fff; width: 320px; flex-shrink: 0; display: flex; align-items: center; padding: 12px 15px; font-size: 13.5px; color: #444; box-shadow: 4px 0 10px -4px rgba(0,0,0,0.1); border-right: 1px solid #eee; }
    .g-col-personil { position: sticky; left: 0; z-index: 25; background-color: #fff; width: 220px; flex-shrink: 0; display: flex; align-items: center; padding: 8px 10px; font-size: 0.85rem; font-weight: bold; color: #333; border-right: 1px solid #eee; }
    .g-col-pekerjaan { position: sticky; left: 220px; z-index: 25; background-color: #fff; width: 250px; flex-shrink: 0; display: flex; align-items: center; padding: 8px 10px; font-size: 0.85rem; color: #555; border-right: 1px solid #ddd; box-shadow: 4px 0 5px -2px rgba(0,0,0,0.1); }
    .g-header-row .g-col-personil, .g-header-row .g-col-pekerjaan, .g-header-row .g-sticky-col { background-color: #f8f9fa; color: #555; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; justify-content: center; text-align: center; }
    .g-data-row:hover .g-col-personil, .g-data-row:hover .g-col-pekerjaan, .g-data-row:hover .g-sticky-col { background-color: #f0f7ff; color: var(--primary-color); }
    .g-timeline-col { position: relative; flex-grow: 1; background-color: #ffffff; }
    .g-header-row { background-color: #f8f9fa; height: 55px; border-bottom: 1px solid #dee2e6; }
    .g-data-row:nth-child(even) .g-sticky-col, .g-data-row:nth-child(even) .g-timeline-col { background-color: #fafbfc; }
    .g-data-row:hover .g-timeline-col { background-color: #f0f7ff; }
    .g-bar { position: absolute; height: 24px; top: 50%; transform: translateY(-50%); border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.2s; z-index: 10; }
    .g-bar:hover { transform: translateY(-50%) scaleY(1.15); box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 30; }
    .bar-blue { background: linear-gradient(180deg, #4e73df 0%, #224abe 100%); }
    .bar-red { background: linear-gradient(180deg, #e74a3b 0%, #be2617 100%); }
    .bar-green { background: linear-gradient(180deg, #1cc88a 0%, #13855c 100%); }
    .bar-grey  { background: linear-gradient(180deg, #858796 0%, #60616f 100%); }
    .month-marker { position: absolute; top: 0; height: 100%; border-left: 1px dashed #e0e0e0; font-size: 11px; padding-left: 8px; padding-top: 18px; color: #888; font-weight: 600; pointer-events: none; text-transform: uppercase; }

    /* LOADING */
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }

    /* TOOLTIP */
    .custom-tooltip { position: fixed; display: none; background: rgba(255, 255, 255, 0.98); border: 1px solid #eee; border-left: 5px solid var(--primary-color); padding: 12px 16px; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 9999; pointer-events: none; min-width: 200px; max-width: 300px; font-size: 0.85rem; animation: fadeIn 0.2s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .ct-header { font-weight: bold; color: #333; margin-bottom: 5px; line-height: 1.2; font-size: 0.95rem; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
    .ct-row { margin-bottom: 3px; display: flex; align-items: center; color: #555; }
    .ct-row i { width: 20px; text-align: center; margin-right: 5px; color: #888; }
    .ct-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-top: 5px; }
    
    input[list] { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23333" class="bi bi-chevron-down" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 12px; padding-right: 2rem; cursor: pointer; }
  </style>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const CONST_API_URL = "https://script.google.com/macros/s/AKfycbxzZ50romtTo7HIMfX8fi9k7_YKpstDFu1B_hjcYfxbJS-a598BkmzATYzUeC03Laktug/exec";

    const fetchAPI = async (action, method = 'GET', data = null) => {
      let url = `${CONST_API_URL}?action=${action}`;
      const options = { method };
      if (method === 'POST') {
        options.headers = { "Content-Type": "text/plain;charset=utf-8" };
        options.body = JSON.stringify({ action, ...data });
      }
      const response = await fetch(url, options);
      if (!response.ok) throw new Error('Network response was not ok');
      return await response.json();
    };

    const parseDate = (dateStr) => {
      if (!dateStr || dateStr.trim() === '-' || dateStr.trim() === '') return null;
      if (dateStr.includes('T')) return new Date(dateStr);
      const parts = dateStr.split(' ');
      if (parts.length < 3) return new Date(dateStr);
      const day = parseInt(parts[0]);
      const monthStr = parts[1].toLowerCase();
      const year = parseInt(parts[2]);
      const months = { 'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'mei': 4, 'may': 4, 'jun': 5, 'jul': 6, 'ags': 7, 'aug': 7, 'sep': 8, 'okt': 9, 'oct': 9, 'nov': 10, 'des': 11, 'dec': 11 };
      const month = months[monthStr] !== undefined ? months[monthStr] : 0;
      return new Date(year, month, day);
    };

    const formatMonthYear = (date) => {
      const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
      return `${months[date.getMonth()]} ${date.getFullYear().toString().substr(2, 2)}`;
    };

    const useCounter = (end, duration = 800) => {
      const [count, setCount] = useState(0);
      useEffect(() => {
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          setCount(Math.floor(progress * end));
          if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
      }, [end, duration]);
      return count;
    };

    const LoadingOverlay = ({ text }) => (
      <div id="loading-overlay">
        <div className="spinner-border text-primary" role="status" style={{ width: '3rem', height: '3rem' }}></div>
        <div className="mt-3 fw-bold text-secondary">{text}</div>
      </div>
    );

    const LoginSection = ({ onLogin }) => {
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(false);
      const [shake, setShake] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(false);
        try {
          const response = await fetchAPI('login', 'POST', { password });
          if (response && response.valid) {
            onLogin(response.role);
          } else {
            setError(true);
            setShake(true);
            setTimeout(() => setShake(false), 400);
          }
        } catch (err) {
          setError(true);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div id="login-section">
          <div className={`login-card ${shake ? 'shake-anim' : ''}`}>
            <img src="IMG_0992.PNG" alt="Logo" className="login-logo" />
            <h3 className="login-title">SIDAMON</h3>
            <p className="login-subtitle">Sistem Database & Monitoring</p>
            <form onSubmit={handleSubmit}>
              <div className="form-floating mb-4 text-start">
                <input type="password" class="form-control" id="passwordInput" placeholder="Password" required value={password} onChange={(e) => { setPassword(e.target.value); setError(false); }} />
                <label htmlFor="passwordInput">Masukkan Password Akses</label>
              </div>
              <button type="submit" className="btn btn-login w-100" disabled={loading}>
                {loading ? <><span className="spinner-border spinner-border-sm me-2"></span>Memeriksa...</> : 'MASUK DASHBOARD'}
              </button>
              {error && (
                <div className="login-alert">
                  <i className="bi bi-exclamation-triangle-fill"></i>
                  <span>Password Salah. Silahkan coba lagi.</span>
                </div>
              )}
            </form>
          </div>
          <div className="login-footer">Â© 2026 Gaharu Sempana Group. All Rights Reserved.<br />Developed by IT Division</div>
        </div>
      );
    };

    const Navbar = ({ role }) => {
      const [greeting, setGreeting] = useState({ text: '', icon: '', roleText: '' });

      useEffect(() => {
        const updateGreeting = () => {
          const hour = new Date().getHours();
          let timeText = "", icon = "";
          if (hour >= 5 && hour < 11) { timeText = "Selamat Pagi"; icon = "bi-brightness-alt-high-fill text-warning"; }
          else if (hour >= 11 && hour < 15) { timeText = "Selamat Siang"; icon = "bi-sun-fill text-warning"; }
          else if (hour >= 15 && hour < 18) { timeText = "Selamat Sore"; icon = "bi-sunset-fill text-warning"; }
          else { timeText = "Selamat Malam"; icon = "bi-moon-stars-fill text-white"; }

          let roleText = "Gaharu Sempana Group";
          if (role === 'SUPER_ADMIN') roleText = "Manajemen Gaharu Sempana Group";
          else if (role === 'ADMIN') roleText = "Tim Admin Gaharu Sempana Group";
          else if (role === 'TEKNIS') roleText = "Tim Teknis Gaharu Sempana Group";
          else if (role === 'ADMIN_INPUT') roleText = "Tim Admin Database Gaharu Sempana Group";

          setGreeting({ text: timeText, icon, roleText });
        };
        updateGreeting();
        const interval = setInterval(updateGreeting, 60000);
        return () => clearInterval(interval);
      }, [role]);

      return (
        <nav className="navbar navbar-dark bg-primary shadow-sm mb-4 py-2">
          <div className="container-fluid px-4 px-lg-5 d-flex justify-content-between align-items-center">
            <div className="d-flex align-items-center">
              <div className="logo-wrapper">
                <img src="IMG_0992.PNG" alt="Logo" style={{ height: '45px', width: 'auto' }} />
              </div>
              <div className="d-flex flex-column justify-content-center">
                <span className="text-white fw-bold" style={{ fontSize: '1.1rem', letterSpacing: '0.5px', lineHeight: '1.2' }}>SIDAMON Gaharu Sempana Group</span>
                <span className="text-white text-uppercase" style={{ fontSize: '0.75rem', letterSpacing: '1px', opacity: '0.85' }}>Dashboard Sistem Database & Monitoring</span>
              </div>
            </div>
            <div className="d-none d-md-block greeting-wrapper text-end text-white">
              <div id="greeting-time" style={{ fontSize: '0.75rem', opacity: 0.9, fontWeight: 300, textTransform: 'uppercase' }}>
                <i className={`bi ${greeting.icon} me-1`}></i> {greeting.text}
              </div>
              <div id="greeting-role" style={{ fontSize: '0.9rem', fontWeight: 600, lineHeight: '1.2' }}>{greeting.roleText}</div>
            </div>
          </div>
        </nav>
      );
    };

    const GanttChart = ({ data, type, filterStart, filterEnd, search }) => {
      const [tooltip, setTooltip] = useState({ show: false, x: 0, y: 0, data: null });
      
      const processedData = useMemo(() => {
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const validItems = [];
        let minDate = new Date(2099, 11, 31);
        let maxDate = new Date(1970, 0, 1);
        const fStart = filterStart ? new Date(filterStart) : null;
        const fEnd = filterEnd ? new Date(filterEnd) : null;
        if (fEnd) fEnd.setHours(23, 59, 59);

        data.forEach(row => {
          if (!row[1]) return;
          let personName = "", projectName = "", fullTitle = "";
          let startRaw, endRaw, statusText, status, barClass = 'bar-blue';

          if (type === 'penugasan') {
            personName = row[1]; projectName = row[2]; fullTitle = `${personName} - ${projectName}`;
            startRaw = row[9]; endRaw = row[10]; statusText = row[12] || "Unknown"; status = statusText.toLowerCase();
            if (status.includes('completed')) return;
            if (status.includes('active')) barClass = 'bar-green';
            else if (status.includes('not started')) barClass = 'bar-grey';
            else barClass = 'bar-green';
          } else {
            projectName = row[2]; fullTitle = projectName;
            statusText = row[16] || "Unknown"; status = statusText.toLowerCase();
            if (status.includes('done') || status.includes('selesai')) return;
            startRaw = type === 'kontrak' ? row[8] : row[12];
            endRaw = type === 'kontrak' ? row[9] : row[13];
            const itemEndCheck = parseDate(endRaw);
            if (itemEndCheck && itemEndCheck < today) barClass = 'bar-red';
          }

          if (search && !fullTitle.toLowerCase().includes(search)) return;

          const itemStart = parseDate(startRaw);
          const itemEnd = parseDate(endRaw);

          if (itemStart && itemEnd && itemEnd >= itemStart) {
            if (fStart && itemEnd < fStart) return;
            if (fEnd && itemStart > fEnd) return;
            if (itemStart < minDate) minDate = new Date(itemStart);
            if (itemEnd > maxDate) maxDate = new Date(itemEnd);
            validItems.push({ person: personName, project: projectName, title: fullTitle, start: itemStart, end: itemEnd, barClass, status: statusText });
          }
        });

        validItems.sort((a, b) => a.start - b.start);
        
        let viewStart = fStart || new Date(minDate);
        let viewEnd = fEnd || new Date(maxDate);
        viewStart.setDate(1); viewEnd.setDate(1); viewEnd.setMonth(viewEnd.getMonth() + 1); viewEnd.setDate(0);
        
        const totalDays = Math.max(1, Math.ceil((viewEnd - viewStart) / (1000 * 60 * 60 * 24)));
        const pxPerDay = 5;
        const chartWidth = totalDays * pxPerDay;

        const markers = [];
        let curr = new Date(viewStart); curr.setDate(1);
        while (curr <= viewEnd) {
          const diffDays = Math.max(0, Math.ceil((curr - viewStart) / (1000 * 60 * 60 * 24)));
          const leftPos = diffDays * pxPerDay;
          if (leftPos < chartWidth) markers.push({ left: leftPos, label: formatMonthYear(curr) });
          curr.setMonth(curr.getMonth() + 1);
        }

        return { items: validItems, viewStart, chartWidth, pxPerDay, markers, hasData: validItems.length > 0 };
      }, [data, type, filterStart, filterEnd, search]);

      if (!processedData.hasData) return <div className="text-center py-5 text-muted">Tidak ada data aktif pada rentang tanggal tersebut.</div>;

      const handleMouseMove = (e, item) => {
        const tWidth = 220; 
        let leftPos = e.clientX + 15;
        if (leftPos + tWidth > window.innerWidth) leftPos = e.clientX - tWidth - 10;
        setTooltip({ show: true, x: leftPos, y: e.clientY + 15, data: item });
      };

      return (
        <React.Fragment>
          <div className="custom-gantt-wrapper">
            <div className="g-row-container g-header-row">
              {type === 'penugasan' ? (
                <React.Fragment>
                  <div className="g-col-personil">NAMA PERSONIL</div>
                  <div className="g-col-pekerjaan">NAMA PEKERJAAN</div>
                </React.Fragment>
              ) : (
                <div className="g-sticky-col">NAMA PEKERJAAN</div>
              )}
              <div className="g-timeline-col" style={{ minWidth: processedData.chartWidth }}>
                {processedData.markers.map((m, i) => (
                  <span key={i} className="month-marker" style={{ left: m.left }}>{m.label}</span>
                ))}
              </div>
            </div>
            {processedData.items.map((item, idx) => {
              const startDiff = Math.ceil((item.start - processedData.viewStart) / (1000 * 60 * 60 * 24));
              const duration = Math.ceil((item.end - item.start) / (1000 * 60 * 60 * 24));
              let leftPx = startDiff * processedData.pxPerDay;
              let widthPx = duration * processedData.pxPerDay;
              if (leftPx < 0) { widthPx += leftPx; leftPx = 0; }
              const widthSafe = Math.max(widthPx, 0);
              
              return (
                <div className="g-row-container g-data-row" key={idx}>
                  {type === 'penugasan' ? (
                    <React.Fragment>
                      <div className="g-col-personil" title={item.person}>{item.person}</div>
                      <div className="g-col-pekerjaan" title={item.project}>{item.project}</div>
                    </React.Fragment>
                  ) : (
                    <div className="g-sticky-col" title={item.project}>{item.project}</div>
                  )}
                  <div className="g-timeline-col" style={{ minWidth: processedData.chartWidth }}>
                    <div className={`g-bar ${item.barClass}`} style={{ left: leftPx, width: widthSafe, display: widthSafe > 0 ? 'block' : 'none' }} onMouseMove={(e) => handleMouseMove(e, item)} onMouseLeave={() => setTooltip({ ...tooltip, show: false })}></div>
                  </div>
                </div>
              );
            })}
          </div>
          {tooltip.show && (
            <div className="custom-tooltip" style={{ display: 'block', top: tooltip.y, left: tooltip.x, borderLeftColor: tooltip.data.barClass.includes('red') ? '#d9534f' : '#000080' }}>
              <div className="ct-header">{tooltip.data.title}</div>
              <div className="ct-row"><i className="bi bi-calendar-event"></i> Start: {tooltip.data.start.toLocaleDateString('id-ID')}</div>
              <div className="ct-row"><i className="bi bi-calendar-check"></i> End: {tooltip.data.end.toLocaleDateString('id-ID')}</div>
              <div className="ct-badge" style={{ background: tooltip.data.barClass.includes('red') ? '#ffe5e5' : '#e6f0ff', color: tooltip.data.barClass.includes('red') ? '#d9534f' : '#000080' }}>{tooltip.data.status}</div>
            </div>
          )}
        </React.Fragment>
      );
    };

    const Dashboard = ({ userRole, logout }) => {
      const [view, setView] = useState('skk');
      const [dataSKK, setDataSKK] = useState([]);
      const [dataTugas, setDataTugas] = useState([]);
      const [dataProject, setDataProject] = useState([]);
      const [loading, setLoading] = useState(true);
      const [search, setSearch] = useState('');
      const [subView, setSubView] = useState('table'); 
      const [filters, setFilters] = useState({ start: '', end: '' });
      const [modalData, setModalData] = useState(null);
      const [dropdowns, setDropdowns] = useState({ nama: [], perusahaan: [], sertifikat: [], jenjang: [] });

      useEffect(() => {
        const loadData = async () => {
          setLoading(true);
          try {
            if (userRole !== "TEKNIS") {
              const [resSKK, resTugas] = await Promise.all([fetchAPI('getDataSKK'), fetchAPI('getDataPenugasan')]);
              setDataSKK(resSKK); setDataTugas(resTugas);
            }
            if (userRole === "SUPER_ADMIN" || userRole === "TEKNIS") {
              const resProj = await fetchAPI('getDataProject');
              setDataProject(resProj);
            }
            if (userRole === "SUPER_ADMIN" || userRole === "ADMIN_INPUT") {
               const resDrop = await fetchAPI('getDropdownData');
               setDropdowns(resDrop);
            }
          } catch (e) { console.error(e); }
          finally { setLoading(false); }
        };
        loadData();
      }, [userRole]);

      const statsSKK = useMemo(() => {
        let activeMap = {};
        dataTugas.forEach(row => { if(row[1] && (row[12]||"").toLowerCase().includes('active')) activeMap[row[1].trim()] = row[5]; });
        let total = 0, expired = 0, used = 0;
        const grouped = {};
        dataSKK.forEach(row => {
          if(!row[1]) return;
          if(!grouped[row[1]]) { grouped[row[1]] = { items: [] }; total++; }
          let s = (row[10]||"").toLowerCase();
          let k = (row[11]||"").toLowerCase();
          if(s.includes('expired')) expired++;
          let isItemUsed = false;
          if (activeMap[row[1].trim()]) isItemUsed = true;
          else if (s.includes('used') || k.includes('used')) isItemUsed = true;
          if(isItemUsed) grouped[row[1]].used = true;
        });
        used = Object.values(grouped).filter(g => g.used).length;
        return { total, expired, used };
      }, [dataSKK, dataTugas]);

      const handleSave = async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = {
          nama: form.inputNama.value,
          perusahaan: form.inputPerusahaan.value,
          sertifikat: form.inputSertifikat.value,
          jenjang: form.inputJenjang.value,
          asosiasi: form.inputAsosiasi.value,
          masaBerlaku: form.inputMasaBerlaku.value,
          keterangan: form.inputKeterangan.value,
          rowNumber: modalData?.rowNumber || ""
        };
        const modalEl = document.getElementById('modalTambahData');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();

        const { value: password } = await Swal.fire({
          title: 'Konfirmasi Password', text: 'Masukkan password Anda:', input: 'password',
          showCancelButton: true, confirmButtonText: 'Simpan', confirmButtonColor: '#000080'
        });

        if (password) {
          setLoading(true);
          try {
            const res = await fetchAPI('saveData', 'POST', { password, payload: formData });
            if(res === "Sukses") {
               Swal.fire('Berhasil', 'Data disimpan', 'success');
               const resSKK = await fetchAPI('getDataSKK');
               setDataSKK(resSKK);
            } else {
               Swal.fire('Gagal', res, 'error');
            }
          } catch(err) { Swal.fire('Error', err.message, 'error'); }
          finally { setLoading(false); }
        }
      };

      const renderSKKTable = () => {
        let activeMap = {};
        dataTugas.forEach(row => { if(row[1] && (row[12]||"").toLowerCase().includes('active')) activeMap[row[1].trim()] = row[5]; });
        const grouped = {};
        dataSKK.filter(r => !search || (r[1]||"").toLowerCase().includes(search.toLowerCase()) || (r[5]||"").toLowerCase().includes(search.toLowerCase())).forEach((row, idx) => {
          const name = row[1]; if(!name) return;
          if(!grouped[name]) grouped[name] = { ...row, items: [] };
          grouped[name].items.push({ ...row, originalIndex: idx, rowNum: row[row.length-1] });
        });
        
        const rows = Object.values(grouped).map((person, i) => {
          let isUsed = false, hasActive = false, usedProj = "";
          person.items.forEach(item => {
            const s = (item[10]||"").toLowerCase();
            if(activeMap[person[1].trim()]) { isUsed = true; usedProj = activeMap[person[1].trim()]; }
            else if (s.includes('used') || (item[11]||"").toLowerCase().includes('used')) { isUsed = true; usedProj = "Used"; }
            if(s.includes('active') || s.includes('available')) hasActive = true;
          });
          const badge = isUsed ? <span className="badge-status status-used">{usedProj.includes('Used') ? usedProj : `Used in ${usedProj}`}</span> 
                      : hasActive ? <span className="badge-status status-active">Available</span>
                      : <span className="badge-status status-expired">Expired</span>;
          let btnWA = "-";
          const hp = person[2];
          if(hp && hp.match(/\d+/)) {
             let num = hp.toString().replace(/\D/g, '');
             if(num.startsWith('0')) num = '62'+num.substring(1);
             if(num.length > 9) btnWA = <a href={`https://wa.me/${num}`} target="_blank" rel="noreferrer" className="btn btn-success btn-sm text-white fw-bold d-inline-flex align-items-center justify-content-center" style={{fontSize:'0.7rem', padding:'2px 8px', height:'24px'}}><i className="bi bi-whatsapp me-1"></i> Chat</a>;
             else btnWA = <span className="small text-muted">{hp}</span>;
          }
          return (
            <tr key={i}>
              <td className="align-middle-person">
                <div className="fw-bold text-dark">{person[1]}</div>
                <div className="small text-muted" style={{lineHeight:1.2}}><i className="bi bi-building me-1"></i>{person[4]||'-'}</div>
              </td>
              <td className="text-center align-middle-person">{btnWA}</td>
              <td className="align-middle-person small" style={{lineHeight:1.3}}>{person[3]}</td>
              <td style={{padding:0}}>{person.items.map((it, k) => <div key={k} className="nested-cell fw-bold" style={{lineHeight:1.3}}>{it[5]}</div>)}</td>
              <td style={{padding:0}}>{person.items.map((it, k) => <div key={k} className="nested-cell justify-content-center text-center">{it[6]||'-'}</div>)}</td>
              <td style={{padding:0}}>{person.items.map((it, k) => <div key={k} className="nested-cell justify-content-center text-center small" style={{color: (it[10]||"").includes('expired')?'#dc3545':'inherit', fontWeight: (it[10]||"").includes('expired')?700:'normal'}}>{it[9]||'-'}</div>)}</td>
              <td className="text-center align-middle-person">{badge}</td>
              <td style={{padding:0}}>{person.items.map((it, k) => <div key={k} className="nested-cell small text-muted" style={{lineHeight:1.2}}>{it[11]||''}</div>)}</td>
              {(userRole === 'SUPER_ADMIN' || userRole === 'ADMIN_INPUT') && (
                <td className="text-center" style={{padding:0}}>
                  {person.items.map((it, k) => (
                    <div key={k} className="nested-cell nested-cell-action">
                      <button className="btn btn-sm btn-outline-primary rounded-circle" style={{width:24, height:24, padding:0}} 
                        onClick={() => {
                            setModalData({ rowNumber: it.rowNum, nama: it[1], perusahaan: it[4], sertifikat: it[5], jenjang: it[6], asosiasi: it[7], masaBerlaku: it[8], keterangan: it[11] });
                            new bootstrap.Modal(document.getElementById('modalTambahData')).show();
                        }}>
                        <i className="bi bi-pencil-fill" style={{fontSize:'0.7rem'}}></i>
                      </button>
                    </div>
                  ))}
                </td>
              )}
            </tr>
          );
        });
        return rows;
      };

      const skkRows = renderSKKTable();
      const skkTotalAnim = useCounter(statsSKK.total);
      const skkUsedAnim = useCounter(statsSKK.used);
      const skkExpiredAnim = useCounter(statsSKK.expired);

      return (
        <React.Fragment>
          <Navbar role={userRole} />
          <div className="container-fluid px-4 px-lg-5 pb-5">
            <ul className="nav nav-pills mb-4 justify-content-center gap-3">
              {userRole !== 'TEKNIS' && (
                <React.Fragment>
                  <li className="nav-item"><button className={`nav-link ${view==='skk'?'active':''}`} onClick={()=>setView('skk')}><i className="bi bi-person-badge me-2"></i>Sertifikat Keahlian</button></li>
                  <li className="nav-item"><button className={`nav-link ${view==='penugasan'?'active':''}`} onClick={()=>setView('penugasan')}><i className="bi bi-calendar-check me-2"></i>Waktu Penugasan</button></li>
                </React.Fragment>
              )}
              {(userRole === 'SUPER_ADMIN' || userRole === 'TEKNIS') && (
                <li className="nav-item"><button className={`nav-link ${view==='project'?'active':''}`} onClick={()=>setView('project')}><i className="bi bi-kanban me-2"></i>Master Project</button></li>
              )}
            </ul>

            {view === 'skk' && (
              <div className="view-section animate__animated animate__fadeIn">
                <div className="stats-wrapper">
                  <div className="row g-3 mb-4 justify-content-center">
                    <div className="col-12 col-sm-6 col-lg-4">
                      <div className="stat-card bg-gradient-primary p-3 d-flex justify-content-between align-items-center">
                        <div><div className="stat-label">Total Personil</div><div className="stat-value">{skkTotalAnim}</div></div>
                        <i className="bi bi-people-fill fs-1 opacity-50"></i>
                      </div>
                    </div>
                    <div className="col-12 col-sm-6 col-lg-4">
                      <div className="stat-card bg-gradient-danger p-3 d-flex justify-content-between align-items-center">
                        <div><div className="stat-label">Expired</div><div className="stat-value">{skkExpiredAnim}</div></div>
                        <i className="bi bi-exclamation-triangle-fill fs-1 opacity-50"></i>
                      </div>
                    </div>
                    <div className="col-12 col-sm-6 col-lg-4">
                      <div className="stat-card bg-gradient-warning p-3 d-flex justify-content-between align-items-center">
                        <div><div className="stat-label">Personil Terpakai</div><div className="stat-value">{skkUsedAnim}</div></div>
                        <i className="bi bi-briefcase-fill fs-1 opacity-50"></i>
                      </div>
                    </div>
                  </div>
                </div>
                <div className="row mb-4 g-2 align-items-center">
                  <div className={`col-md ${userRole==='ADMIN'?'col-12':''}`}>
                    <div className="position-relative w-100">
                      <i className="bi bi-search search-icon"></i>
                      <input type="text" className="form-control search-input" placeholder="Cari Nama Personil, Sertifikat..." value={search} onChange={e=>setSearch(e.target.value)} />
                    </div>
                  </div>
                  {(userRole === 'SUPER_ADMIN' || userRole === 'ADMIN_INPUT') && (
                    <div className="col-md-auto">
                      <button className="btn btn-success rounded-pill fw-bold shadow-sm h-100 px-4" onClick={()=>{setModalData(null); new bootstrap.Modal(document.getElementById('modalTambahData')).show();}}>
                        <i className="bi bi-plus-lg me-2"></i>Tambah Data
                      </button>
                    </div>
                  )}
                </div>
                <div className="table-card">
                  <div className="table-responsive">
                    <table className="table table-hover align-middle">
                      <thead className="table-light">
                        <tr>
                          <th style={{width:'20%', minWidth:200}}>Nama Personil</th>
                          <th className="text-center" style={{width:'10%'}}>Kontak (WA)</th>
                          <th style={{width:'20%', minWidth:150}}>Jenjang & Bidang Ilmu</th>
                          <th style={{width:'20%', minWidth:150}}>Sertifikat</th>
                          <th className="text-center" style={{width:'8%'}}>Jenjang</th>
                          <th className="text-center" style={{width:'8%'}}>Sisa Waktu</th>
                          <th className="text-center" style={{width:'10%'}}>Status</th>
                          <th style={{width:'15%'}}>Keterangan</th>
                          {(userRole === 'SUPER_ADMIN' || userRole === 'ADMIN_INPUT') && <th className="text-center" style={{width:'5%'}}>Aksi</th>}
                        </tr>
                      </thead>
                      <tbody>{skkRows}</tbody>
                    </table>
                    {skkRows.length === 0 && <div className="text-center py-4 text-muted">Data tidak ditemukan.</div>}
                  </div>
                </div>
              </div>
            )}

            {view === 'penugasan' && (
              <div className="view-section animate__animated animate__fadeIn">
                 <div className="table-card">
                    <div className="row gy-3 align-items-center mb-4">
                       <div className="col-12 col-xl-auto">
                          <div className="sub-nav btn-group w-100">
                             <button className={`btn ${subView==='table'?'active':''}`} onClick={()=>setSubView('table')}><i className="bi bi-table me-1"></i>Tabel</button>
                             <button className={`btn ${subView==='gantt'?'active':''}`} onClick={()=>setSubView('gantt')}><i className="bi bi-bar-chart-steps me-1"></i>Timeline</button>
                          </div>
                       </div>
                       <div className="col-12 col-xl ms-xl-auto">
                          <div className="position-relative w-100">
                             <i className="bi bi-search search-icon"></i>
                             <input type="text" className="form-control search-input" placeholder="Cari..." value={search} onChange={e=>setSearch(e.target.value)}/>
                          </div>
                       </div>
                    </div>
                    {subView === 'table' ? (
                       <div className="table-responsive">
                          <table className="table table-hover align-middle">
                             <thead><tr><th style={{minWidth:180}}>Nama Personil</th><th style={{minWidth:200}}>Nama Paket</th><th className="text-center">LPSE</th><th>Sertifikat</th><th className="text-center">Status</th></tr></thead>
                             <tbody>
                                {dataTugas.filter(r=>(r[12]||"").toLowerCase()!=='completed' && (!search || (r[1]||"").toLowerCase().includes(search.toLowerCase()))).map((row, i) => {
                                   let status = (row[12]||"").toLowerCase();
                                   let badge = status.includes('active')?'status-active':status.includes('not started')?'status-not-started':'status-expired';
                                   return (
                                      <tr key={i}>
                                         <td className="fw-bold">{row[1]}</td><td>{row[2]}</td><td className="text-center">{row[5]||'-'}</td><td className="small">{row[6]}</td>
                                         <td className="text-center"><span className={`badge-status ${badge}`}>{row[12]}</span></td>
                                      </tr>
                                   )
                                })}
                             </tbody>
                          </table>
                       </div>
                    ) : (
                       <GanttChart data={dataTugas} type="penugasan" search={search.toLowerCase()} />
                    )}
                 </div>
              </div>
            )}

            {view === 'project' && (
               <div className="view-section animate__animated animate__fadeIn">
                  <div className="table-card">
                     <div className="row gy-3 align-items-center mb-4">
                        <div className="col-12 col-xl-auto">
                           <div className="sub-nav btn-group w-100">
                              <button className={`btn ${subView==='table'?'active':''}`} onClick={()=>setSubView('table')}><i className="bi bi-table me-1"></i>Tabel</button>
                              <button className={`btn ${subView==='gantt-kontrak'?'active':''}`} onClick={()=>setSubView('gantt-kontrak')}>Timeline Kontrak</button>
                              <button className={`btn ${subView==='gantt-schedule'?'active':''}`} onClick={()=>setSubView('gantt-schedule')}>Timeline Schedule</button>
                           </div>
                        </div>
                        {subView !== 'table' && (
                           <div className="col-12 col-xl-auto d-flex gap-2">
                              <input type="date" className="form-control form-control-sm" onChange={e=>setFilters({...filters, start:e.target.value})} />
                              <input type="date" className="form-control form-control-sm" onChange={e=>setFilters({...filters, end:e.target.value})} />
                           </div>
                        )}
                        <div className="col-12 col-xl ms-xl-auto">
                            <div className="position-relative">
                               <i className="bi bi-search search-icon"></i>
                               <input type="text" className="form-control search-input" placeholder="Cari Project..." value={search} onChange={e=>setSearch(e.target.value)}/>
                            </div>
                        </div>
                     </div>
                     {subView === 'table' ? (
                        <div className="table-responsive">
                           <table className="table table-hover align-middle">
                              <thead className="table-light text-center"><tr><th>Pekerjaan</th><th>Kordinator</th><th>Link</th><th>Priority</th><th>Deadline Kontrak</th><th>Deadline Schedule</th><th>Status</th><th>Keterangan</th></tr></thead>
                              <tbody>
                                 {dataProject.filter(r=>(!search || (r[2]||"").toLowerCase().includes(search.toLowerCase()))).map((row, i) => {
                                    // LOGIKA WARNA BADGE DIPERBAIKI SESUAI SCRIPT ASLI
                                    const statusText = row[16] || "";
                                    const rawStatus = statusText.toLowerCase().trim();
                                    const isDone = rawStatus.includes('done') || rawStatus.includes('selesai');
                                    
                                    let badgeClass = "bg-secondary";
                                    if (rawStatus.includes('ongoing')) badgeClass = "bg-info text-white";
                                    else if (rawStatus.includes('dummy')) badgeClass = "bg-warning text-dark";
                                    else if (isDone) badgeClass = "bg-success";
                                    else if (rawStatus.includes('past')) badgeClass = "bg-danger";

                                    // LOGIKA EXPIRED DEADLINE
                                    const today = new Date(); today.setHours(0,0,0,0);
                                    const checkExpired = (d) => {
                                        if(!d) return false;
                                        const dt = parseDate(d);
                                        return dt && dt < today;
                                    };
                                    const kExp = !isDone && checkExpired(row[9]);
                                    const sExp = !isDone && checkExpired(row[13]);

                                    return (
                                        <tr key={i}>
                                           <td className="fw-bold">{row[2]}</td><td>{row[4]}</td>
                                           <td className="text-center">{row[5] && row[5].includes('http') ? <a href={row[5]} target="_blank" rel="noreferrer" className="btn btn-primary btn-sm px-2 py-0" style={{height:24, fontSize:'0.7rem'}}>Link</a> : '-'}</td>
                                           <td className="text-center"><span className={`badge ${row[7]==='High'?'bg-danger':row[7]==='Medium'?'bg-warning text-dark':'bg-info'}`}>{row[7]||'Low'}</span></td>
                                           <td className="text-center small text-muted">{isDone ? <i className="bi bi-check-circle-fill text-success" style={{fontSize:'1.2rem'}}></i> : kExp ? <span className="text-danger fw-bold">EXPIRED</span> : row[9]||'-'}</td>
                                           <td className="text-center small text-muted">{isDone ? <i className="bi bi-check-circle-fill text-success" style={{fontSize:'1.2rem'}}></i> : sExp ? <span className="text-danger fw-bold">EXPIRED</span> : row[13]||'-'}</td>
                                           <td className="text-center"><span className={`badge ${badgeClass}`}>{statusText || 'Not Started'}</span></td>
                                           <td className="small text-muted">{row[18]}</td>
                                        </tr>
                                    );
                                 })}
                              </tbody>
                           </table>
                        </div>
                     ) : (
                        <GanttChart data={dataProject} type={subView === 'gantt-kontrak' ? 'kontrak' : 'schedule'} filterStart={filters.start} filterEnd={filters.end} search={search.toLowerCase()} />
                     )}
                  </div>
               </div>
            )}
          </div>

          {loading && <LoadingOverlay text="Memuat Data..." />}

          {/* MODAL */}
          <div className="modal fade" id="modalTambahData" tabIndex="-1" aria-hidden="true">
            <div className="modal-dialog modal-dialog-centered">
              <div className="modal-content">
                <div className="modal-header bg-primary text-white">
                  <h5 className="modal-title">{modalData ? 'Edit Data' : 'Input Data'}</h5>
                  <button type="button" className="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div className="modal-body">
                  <form id="formInputData" onSubmit={handleSave}>
                    <div className="mb-3"><label className="form-label small fw-bold">Nama Personil</label><input className="form-control" name="inputNama" list="listNama" required defaultValue={modalData?.nama} autoComplete="off"/><datalist id="listNama">{dropdowns.nama.map(d=><option key={d} value={d}/>)}</datalist></div>
                    <div className="mb-3"><label className="form-label small fw-bold">Perusahaan</label><input className="form-control" name="inputPerusahaan" list="listPerusahaan" required defaultValue={modalData?.perusahaan} autoComplete="off"/><datalist id="listPerusahaan">{dropdowns.perusahaan.map(d=><option key={d} value={d}/>)}</datalist></div>
                    <div className="row">
                       <div className="col-md-6 mb-3"><label className="form-label small fw-bold">Sertifikat</label><input className="form-control" name="inputSertifikat" list="listSertifikat" required defaultValue={modalData?.sertifikat} autoComplete="off"/><datalist id="listSertifikat">{dropdowns.sertifikat.map(d=><option key={d} value={d}/>)}</datalist></div>
                       <div className="col-md-6 mb-3"><label className="form-label small fw-bold">Jenjang</label><input className="form-control" name="inputJenjang" list="listJenjang" required defaultValue={modalData?.jenjang} autoComplete="off"/><datalist id="listJenjang">{dropdowns.jenjang.map(d=><option key={d} value={d}/>)}</datalist></div>
                    </div>
                    <div className="mb-3"><label className="form-label small fw-bold">Asosiasi</label><input type="text" className="form-control" name="inputAsosiasi" defaultValue={modalData?.asosiasi} /></div>
                    <div className="mb-3"><label className="form-label small fw-bold">Masa Berlaku</label><input type="date" className="form-control" name="inputMasaBerlaku" required defaultValue={modalData?.masaBerlaku ? (() => { 
                        const d = parseDate(modalData.masaBerlaku); return d ? d.toISOString().split('T')[0] : ''; 
                    })() : ''} /></div>
                    <div className="mb-3"><label className="form-label small fw-bold">Keterangan</label><textarea className="form-control" name="inputKeterangan" rows="2" defaultValue={modalData?.keterangan}></textarea></div>
                    <div className="modal-footer px-0 pb-0">
                       <button type="button" className="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Batal</button>
                       <button type="submit" className="btn btn-primary rounded-pill">Simpan Data</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </React.Fragment>
      );
    };

    const App = () => {
      const [userRole, setUserRole] = useState(null);
      if (!userRole) return <LoginSection onLogin={setUserRole} />;
      return <Dashboard userRole={userRole} logout={() => setUserRole(null)} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
