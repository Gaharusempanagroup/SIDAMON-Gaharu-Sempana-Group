<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SIDAMON Gaharu Sempana Group</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --sidebar-width: 260px;
      --primary-color: #000080;
      --bg-light: #f8f9fc;
      --card-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }

    /* DARK MODE VARIABLES */
    [data-bs-theme="dark"] {
      --bg-light: #1a1c1e;
      --primary-color: #3751FF;
    }

    body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); transition: all 0.3s; }

    /* SIDEBAR STYLES */
    #wrapper { display: flex; width: 100%; align-items: stretch; }
    #sidebar {
      min-width: var(--sidebar-width); max-width: var(--sidebar-width);
      background: var(--primary-color); color: #fff; transition: all 0.3s;
      min-height: 100vh; position: fixed; z-index: 1000;
    }
    #sidebar.active { margin-left: calc(-1 * var(--sidebar-width)); }
    #sidebar .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    #sidebar ul.components { padding: 20px 0; }
    #sidebar ul li { padding: 10px 20px; transition: 0.3s; cursor: pointer; display: flex; align-items: center; gap: 12px; opacity: 0.7; }
    #sidebar ul li:hover, #sidebar ul li.active { opacity: 1; background: rgba(255,255,255,0.1); border-left: 4px solid #fff; }
    
    #content { width: 100%; padding: 20px; margin-left: var(--sidebar-width); transition: all 0.3s; }
    #content.active { margin-left: 0; }

    /* SKELETON LOADING */
    .skeleton { background: #eee; background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%); border-radius: 5px; background-size: 200% 100%; animation: 1.5s shine linear infinite; }
    @keyframes shine { to { background-position-x: -200%; } }
    .sk-text { height: 15px; width: 100%; margin-bottom: 10px; }

    /* CARDS & CHARTS */
    .card { border: none; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 20px; }
    .chart-container { height: 300px; width: 100%; }

    @media (max-width: 768px) {
      #sidebar { margin-left: calc(-1 * var(--sidebar-width)); }
      #sidebar.active { margin-left: 0; }
      #content { margin-left: 0; }
      #content.active { margin-left: var(--sidebar-width); }
    }
  </style>
</head>
<body class="login-mode">

  <div id="login-section">
    <div class="login-card mx-auto mt-5" style="max-width: 400px; padding: 30px; background: #fff; border-radius: 15px;">
        <h3 class="text-center mb-4">SIDAMON LOGIN</h3>
        <input type="password" id="passwordInput" class="form-control mb-3" placeholder="Akses Password">
        <button onclick="handleLogin()" class="btn btn-primary w-100">MASUK</button>
    </div>
  </div>

  <div id="wrapper" style="display: none;">
    <nav id="sidebar">
      <div class="sidebar-header">
        <img src="IMG_0992.PNG" alt="Logo" style="height: 40px; margin-bottom: 10px;">
        <h5 class="mb-0">SIDAMON</h5>
        <small class="opacity-50">Gaharu Sempana Group</small>
      </div>
      <ul class="list-unstyled components">
        <li onclick="switchView('skk')" id="nav-skk" class="active"><i class="bi bi-person-badge"></i> Sertifikat</li>
        <li onclick="switchView('penugasan')" id="nav-penugasan"><i class="bi bi-calendar-check"></i> Penugasan</li>
        <li onclick="switchView('project')" id="nav-project"><i class="bi bi-kanban"></i> Master Project</li>
        <li onclick="switchView('audit')" id="nav-audit" class="d-none"><i class="bi bi-shield-lock"></i> Audit Log</li>
        <li onclick="toggleDarkMode()" class="mt-5"><i class="bi bi-moon-stars"></i> Dark Mode</li>
        <li onclick="logout()"><i class="bi bi-box-arrow-left"></i> Keluar</li>
      </ul>
    </nav>

    <div id="content">
      <nav class="navbar navbar-expand-lg navbar-light bg-white rounded shadow-sm mb-4 px-3">
        <button type="button" id="sidebarCollapse" class="btn btn-primary"><i class="bi bi-list"></i></button>
        <div class="ms-auto d-flex align-items-center">
            <span id="userRoleBadge" class="badge bg-info me-3"></span>
            <div id="greetingText" class="small fw-bold"></div>
        </div>
      </nav>

      <div class="container-fluid">
        <div id="view-skk" class="view-section">
          <div class="row mb-4">
            <div class="col-md-8">
                <div class="card p-3 h-100">
                    <h6>Ringkasan Status Sertifikat</h6>
                    <div id="chart_skk_status" class="chart-container"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 h-100 text-center">
                    <h6>Total Personil</h6>
                    <h1 id="skk-total-val" class="display-4 fw-bold text-primary">0</h1>
                    <button class="btn btn-success mt-auto" onclick="exportData('bodySkk', 'Data_SKK')"><i class="bi bi-file-earmark-excel me-2"></i>Export Excel</button>
                </div>
            </div>
          </div>
          
          <div class="card p-4">
            <div class="d-flex justify-content-between mb-3">
                <input type="text" id="searchSkk" class="form-control w-50 rounded-pill" placeholder="Cari personil...">
                <button class="btn btn-primary rounded-pill" onclick="openModalAdd()">+ Tambah Data</button>
            </div>
            <div id="skk-skeleton" class="d-none">
                <div class="skeleton sk-text"></div><div class="skeleton sk-text"></div><div class="skeleton sk-text"></div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr><th>Nama</th><th>Sertifikat</th><th>Masa Berlaku</th><th>Status</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="bodySkk"></tbody>
                </table>
            </div>
          </div>
        </div>

        <div id="view-audit" class="view-section" style="display:none;">
            <h4>System Audit Log</h4>
            <div class="card p-3">
                <div class="table-responsive" style="max-height: 500px;">
                    <table class="table table-sm">
                        <thead><tr><th>Waktu</th><th>Role</th><th>Aksi</th><th>Detail</th></tr></thead>
                        <tbody id="bodyAudit"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        </div>
    </div>
  </div>

  <script>
    const CONST_API_URL = "URL_WEB_APP_ANDA"; //
    let currentUser = null;

    // --- SESSION & LOGIN ---
    window.onload = () => {
        const savedSession = localStorage.getItem('sidamon_session');
        if (savedSession) {
            currentUser = JSON.parse(savedSession);
            initDashboard();
        }
    };

    async function handleLogin() {
        const pass = document.getElementById('passwordInput').value;
        const btn = document.querySelector('#login-section button');
        btn.disabled = true; btn.innerText = "Memproses...";

        try {
            const res = await fetch(CONST_API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', password: pass })
            }).then(r => r.json());

            if (res.valid) {
                currentUser = { role: res.role, token: Date.now() };
                localStorage.setItem('sidamon_session', JSON.stringify(currentUser));
                initDashboard();
            } else {
                Swal.fire('Gagal', 'Password Salah', 'error');
            }
        } catch(e) { Swal.fire('Error', 'Koneksi Gagal', 'error'); }
        btn.disabled = false; btn.innerText = "MASUK";
    }

    function initDashboard() {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('wrapper').style.display = 'flex';
        document.getElementById('userRoleBadge').innerText = currentUser.role;
        
        if (currentUser.role === 'SUPER_ADMIN') {
            document.getElementById('nav-audit').classList.remove('d-none');
        }
        
        loadAllData();
    }

    function logout() {
        localStorage.removeItem('sidamon_session');
        location.reload();
    }

    // --- UI LOGIC ---
    function switchView(view) {
        document.querySelectorAll('.view-section').forEach(v => v.style.display = 'none');
        document.querySelectorAll('#sidebar li').forEach(l => l.classList.remove('active'));
        document.getElementById('view-' + view).style.display = 'block';
        document.getElementById('nav-' + view).classList.add('active');
        
        if (view === 'audit') loadAuditLogs();
    }

    function toggleDarkMode() {
        const theme = document.body.getAttribute('data-bs-theme');
        document.body.setAttribute('data-bs-theme', theme === 'dark' ? 'light' : 'dark');
    }

    document.getElementById('sidebarCollapse').onclick = () => {
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('content').classList.toggle('active');
    };

    // --- DATA & CHARTS ---
    async function loadAllData() {
        document.getElementById('skk-skeleton').classList.remove('d-none');
        // Panggil API getDataSKK seperti sebelumnya...
        // Setelah data dapat, render chart
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(() => renderStatusChart([['Active', 10], ['Expired', 2]]));
        document.getElementById('skk-skeleton').classList.add('d-none');
    }

    function renderStatusChart(dataArray) {
        const data = google.visualization.arrayToDataTable([['Status', 'Count'], ...dataArray]);
        const chart = new google.visualization.PieChart(document.getElementById('chart_skk_status'));
        chart.draw(data, { 
            pieHole: 0.4, 
            colors: ['#28a745', '#dc3545'],
            chartArea: {width: '100%', height: '80%'}
        });
    }

    async function loadAuditLogs() {
        const res = await fetch(`${CONST_API_URL}?action=getAuditLogs&role=${currentUser.role}`).then(r => r.json());
        const tbody = document.getElementById('bodyAudit');
        tbody.innerHTML = res.map(row => `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td></tr>`).join('');
    }

    // --- EXPORT LOGIC ---
    function exportData(tableId, filename) {
        const table = document.getElementById(tableId);
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, `${filename}_${new Date().toLocaleDateString()}.xlsx`);
    }

  </script>
</body>
</html>
