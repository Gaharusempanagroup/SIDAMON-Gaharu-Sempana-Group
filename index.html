<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SIDAMON Gaharu Sempana Group</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  
  <style>
    :root { --primary-color: #000080; --bg-light: #f4f6f9; }
    html, body { height: 100%; margin: 0; padding: 0; background-color: var(--bg-light); font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
    body.login-mode { overflow: hidden; position: fixed; width: 100%; }
    .bg-primary { background-color: var(--primary-color) !important; }
    .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
    .btn-primary:hover { background-color: #000060; }
    
    /* Login Styles */
    #login-section { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; display: flex; align-items: center; justify-content: center; background: linear-gradient(-45deg, #000428, #004e92, #000080, #1cb5e0); background-size: 400% 400%; animation: gradientBG 15s ease infinite; z-index: 9999; padding: 20px; }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .login-card { width: 100%; max-width: 420px; padding: 40px; border-radius: 20px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.18); text-align: center; animation: fadeInUp 0.8s ease-out; color: white; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    .login-logo { height: 90px; margin-bottom: 20px; }
    .form-floating > .form-control { border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.6); height: 55px; background: rgba(255, 255, 255, 0.25); color: #fff; }
    .form-floating > .form-control:focus { background: rgba(255, 255, 255, 0.35); outline: none; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
    .form-floating > label { color: rgba(255, 255, 255, 0.9); }
    .btn-login { background: rgba(255,255,255,0.15); border: 1px solid rgba(255, 255, 255, 0.6); color: white; height: 55px; border-radius: 50px; font-weight: 600; width: 100%; transition: 0.4s; }
    .btn-login:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-3px); }
    #login-alert { display: none; margin-top: 15px; padding: 12px; border-radius: 15px; background: rgba(220, 53, 69, 0.15); border: 1px solid rgba(220, 53, 69, 0.4); color: #ffcccc; font-size: 0.85rem; }
    
    /* Dashboard & Utils */
    #dashboard-section { display: none; padding-bottom: 50px; }
    .nav-pills .nav-link { border-radius: 50px; color: #555; background: white; border: 1px solid #ddd; margin: 0 5px; }
    .nav-pills .nav-link.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    .stat-card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); color: white; height: 100%; }
    .bg-gradient-primary { background: linear-gradient(45deg, var(--primary-color), #333399); }
    .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); } 
    .bg-gradient-danger { background: linear-gradient(45deg, #e74a3b, #be2617); }
    .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); }
    .table-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .badge-status { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
    .status-expired { background-color: #ffe5e5; color: #cc0000; border: 1px solid #ffcccc; }
    .status-active { background-color: #e5ffe5; color: #007700; border: 1px solid #ccffcc; }
    .status-used { background-color: #fff4e5; color: #cc7700; border: 1px solid #ffeebb; }
    .status-not-started { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: none; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; }
    
    /* Gantt Styles (Simplified for brevity) */
    .custom-gantt-wrapper { display: flex; flex-direction: column; background: #fff; overflow-x: auto; border: 1px solid #e0e0e0; border-radius: 10px; position: relative; }
    .g-row-container { display: flex; min-width: 100%; border-bottom: 1px solid #f2f2f2; }
    .g-sticky-col { position: sticky; left: 0; background: #fff; width: 220px; flex-shrink: 0; padding: 8px 10px; border-right: 1px solid #eee; z-index: 20; display: flex; align-items: center; }
    .g-timeline-col { position: relative; flex-grow: 1; }
    .g-bar { position: absolute; height: 24px; top: 50%; transform: translateY(-50%); border-radius: 6px; cursor: pointer; z-index: 10; }
    .bar-blue { background: #4e73df; } .bar-red { background: #e74a3b; } .bar-green { background: #1cc88a; } .bar-grey { background: #858796; }
    .month-marker { position: absolute; top: 0; border-left: 1px dashed #e0e0e0; padding: 5px; font-size: 11px; color: #888; text-transform: uppercase; }
    .custom-tooltip { position: fixed; display: none; background: rgba(255, 255, 255, 0.98); border: 1px solid #eee; padding: 12px; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 9999; pointer-events: none; }
    
    @media (max-width: 768px) { .g-sticky-col { width: 140px; font-size: 11px; } }
  </style>
</head>
<body class="login-mode">

  <div id="gantt-tooltip" class="custom-tooltip"></div>
  <div id="loading-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-3 fw-bold text-secondary" id="loading-text">Memuat Data...</div>
  </div>

  <div id="login-section">
    <div class="login-card">
        <img src="https://via.placeholder.com/90x90?text=LOGO" alt="Logo" class="login-logo">
      <h3 class="login-title">SIDAMON</h3>
      <p class="login-subtitle">System Database & Monitoring</p>
      
      <form onsubmit="handleLogin(event)">
        <div class="form-floating mb-4 text-start">
          <input type="password" class="form-control" id="passwordInput" placeholder="Password" required oninput="hideLoginError()">
          <label for="passwordInput">Masukkan Password Akses</label>
        </div>
        <button type="submit" class="btn btn-login w-100" id="loginBtn">MASUK DASHBOARD</button>
        <div id="login-alert"><i class="bi bi-exclamation-triangle-fill"></i> <span>Password Salah.</span></div>
      </form>
    </div>
  </div>

  <div id="dashboard-section">
    <nav class="navbar navbar-dark bg-primary shadow-sm mb-4 py-2">
      <div class="container-fluid px-4">
        <div class="d-flex align-items-center">
            <span class="text-white fw-bold">SIDAMON Gaharu Sempana Group</span>
        </div>
      </div>
    </nav>

    <div class="container-fluid px-4 px-lg-5">
      <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab">
        <li class="nav-item" id="nav-skk"><button class="nav-link active" onclick="switchView('skk')">Sertifikat Keahlian</button></li>
        <li class="nav-item" id="nav-penugasan"><button class="nav-link" onclick="switchView('penugasan')">Waktu Penugasan</button></li>
        <li class="nav-item" id="nav-project"><button class="nav-link" onclick="switchView('project')">Master Project</button></li>
      </ul>

      <div id="view-skk" class="view-section active-view">
         <div class="row g-3 mb-4 justify-content-center">
             <div class="col-md-4"><div class="stat-card bg-gradient-primary p-3">Total: <span id="skk-total" class="fw-bold fs-4">0</span></div></div>
             <div class="col-md-4"><div class="stat-card bg-gradient-danger p-3">Expired: <span id="skk-expired" class="fw-bold fs-4">0</span></div></div>
             <div class="col-md-4"><div class="stat-card bg-gradient-warning p-3">Terpakai: <span id="skk-used" class="fw-bold fs-4">0</span></div></div>
         </div>
         
         <div class="row mb-3 align-items-center">
            <div class="col-md"><input type="text" id="searchSkk" class="form-control" placeholder="Cari Nama Personil..."></div>
            <div class="col-md-auto" id="btnAddDataContainer">
                <button class="btn btn-success rounded-pill" onclick="openModalAdd()">+ Tambah Data</button>
            </div>
         </div>

         <div class="table-card table-responsive">
            <table class="table table-hover">
               <thead><tr><th>Nama</th><th>Kontak</th><th>Keahlian</th><th>Sertifikat</th><th>Jenjang</th><th>Masa Berlaku</th><th>Status</th><th>Aksi</th></tr></thead>
               <tbody id="bodySkk"></tbody>
            </table>
         </div>
      </div>

      <div id="view-penugasan" class="view-section" style="display:none;">
          <div class="mb-3">
              <button class="btn btn-sm btn-outline-primary active" onclick="switchTugasSubView('table')">Tabel</button>
              <button class="btn btn-sm btn-outline-primary" onclick="switchTugasSubView('gantt')">Timeline</button>
          </div>
          <div id="subview-tugas-table" class="table-card table-responsive">
             <input type="text" id="searchTugas" class="form-control mb-3" placeholder="Cari...">
             <table class="table table-hover"><thead><tr><th>Personil</th><th>Pekerjaan</th><th>Posisi</th><th>Start</th><th>End</th><th>Status</th></tr></thead><tbody id="bodyTugas"></tbody></table>
          </div>
          <div id="subview-tugas-gantt" style="display:none;" class="table-card">
              <div id="chart_penugasan"></div>
          </div>
      </div>

      <div id="view-project" class="view-section" style="display:none;">
          <div class="mb-3">
             <button class="btn btn-sm btn-outline-primary active" onclick="switchSubView('table')">Tabel</button>
             <button class="btn btn-sm btn-outline-primary" onclick="switchSubView('gantt-kontrak')">Timeline Kontrak</button>
          </div>
          <div id="subview-table" class="table-card table-responsive">
             <input type="text" id="searchProject" class="form-control mb-3" placeholder="Cari Project...">
             <table class="table table-hover"><thead><tr><th>Pekerjaan</th><th>Kordinator</th><th>Deadline</th><th>Status</th></tr></thead><tbody id="bodyProject"></tbody></table>
          </div>
          <div id="subview-gantt-kontrak" style="display:none;" class="table-card">
             <div id="chart_kontrak"></div>
          </div>
      </div>

    </div>
  </div>

  <div class="modal fade" id="modalTambahData" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white"><h5 class="modal-title">Input Data</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="formInputData">
             <input type="hidden" id="editRowNumber">
             <div class="mb-2"><label>Nama</label><input class="form-control" list="listNama" id="inputNama" required><datalist id="listNama"></datalist></div>
             <div class="mb-2"><label>Perusahaan</label><input class="form-control" list="listPerusahaan" id="inputPerusahaan" required><datalist id="listPerusahaan"></datalist></div>
             <div class="row">
                 <div class="col-6 mb-2"><label>Sertifikat</label><input class="form-control" list="listSertifikat" id="inputSertifikat" required><datalist id="listSertifikat"></datalist></div>
                 <div class="col-6 mb-2"><label>Jenjang</label><input class="form-control" list="listJenjang" id="inputJenjang" required><datalist id="listJenjang"></datalist></div>
             </div>
             <div class="mb-2"><label>Asosiasi</label><input class="form-control" id="inputAsosiasi"></div>
             <div class="mb-2"><label>Masa Berlaku</label><input type="date" class="form-control" id="inputMasaBerlaku" required></div>
             <div class="mb-2"><label>Ket</label><textarea class="form-control" id="inputKeterangan"></textarea></div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button class="btn btn-primary" onclick="submitForm()">Simpan</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- KONFIGURASI PENTING ---
    // GANTI URL DI BAWAH INI DENGAN URL DEPLOYMENT WEB APP SCRIPT ANDA
    const CONST_API_URL = "https://script.google.com/macros/s/AKfycbxzZ50romtTo7HIMfX8fi9k7_YKpstDFu1B_hjcYfxbJS-a598BkmzATYzUeC03Laktug/exec";

    // --- HELPER FUNCTION UNTUK FETCH API ---
    async function fetchAPI(action, method = 'GET', data = null) {
        let url = `${CONST_API_URL}?action=${action}`;
        
        const options = {
            method: method,
        };

        if (method === 'POST') {
            // RAHASIA AGAR TIDAK KENA CORS:
            // 1. Gunakan mode 'no-cors' TIDAK BOLEH dipakai jika butuh jawaban (login butuh jawaban)
            // 2. Ganti Content-Type jadi text/plain
            options.headers = {
                "Content-Type": "text/plain;charset=utf-8" 
            };
            // Kirim body sebagai string
            options.body = JSON.stringify({ action: action, ...data });
        }

        try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error('Network response was not ok');
            return await response.json();
        } catch (error) {
            console.error("Fetch Error:", error);
            // Tampilkan error ke user agar tidak stuck loading selamanya
            alert("Gagal menghubungi server: " + error.message);
            throw error;
        }
    }

    // --- LOGIC APLIKASI ---
    let dataSKK = [], dataTugas = [], dataProject = [];
    let currentUserRole = '';
    const activeTimers = {};

    function hideLoginError() { document.getElementById('login-alert').style.display = 'none'; }

    // 1. LOGIN
    async function handleLogin(e) {
        e.preventDefault();
        const btn = document.getElementById('loginBtn');
        const originalText = btn.innerText;
        btn.innerHTML = 'Loading...'; btn.disabled = true;
        
        try {
            // Ganti google.script.run dengan fetchAPI POST
            const pass = document.getElementById('passwordInput').value;
            const res = await fetchAPI('login', 'POST', { password: pass });

            if (res.valid) {
                currentUserRole = res.role;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dashboard-section').style.display = 'block';
                document.body.classList.remove('login-mode');
                applyRoleAccess(currentUserRole);
                loadAllData();
                if(currentUserRole.includes("ADMIN")) loadDropdowns();
            } else {
                document.getElementById('login-alert').style.display = 'block';
                const card = document.querySelector('.login-card');
                card.style.animation = 'none'; card.offsetHeight; /* trigger reflow */
                card.style.animation = 'shake 0.4s'; // (Definisikan keyframes shake di CSS jika mau)
            }
        } catch (err) {
            alert("Koneksi Error: " + err.message);
        } finally {
            btn.innerHTML = originalText; btn.disabled = false;
        }
    }

    function applyRoleAccess(role) {
        // ... (Logika sama dengan kode asli, menyembunyikan elemen DOM)
        const btnAdd = document.getElementById('btnAddDataContainer');
        const navProject = document.getElementById('nav-project');
        
        if (role === "ADMIN") { btnAdd.style.display = 'none'; navProject.style.display = 'none'; }
        if (role === "TEKNIS") { document.getElementById('nav-skk').style.display='none'; document.getElementById('nav-penugasan').style.display='none'; switchView('project'); }
    }

    // 2. LOAD DATA
    async function loadAllData() {
        document.getElementById('loading-overlay').style.display = 'flex';
        
        try {
            if(currentUserRole !== "TEKNIS") {
                // Fetch paralel
                const [skk, tugas] = await Promise.all([
                    fetchAPI('getDataSKK'),
                    fetchAPI('getDataPenugasan')
                ]);
                dataSKK = skk; renderSKK(dataSKK);
                dataTugas = tugas; renderTugas(dataTugas);
            }
            if(currentUserRole === "SUPER_ADMIN" || currentUserRole === "TEKNIS") {
                dataProject = await fetchAPI('getDataProject');
                renderProject(dataProject);
            }
        } catch (e) {
            console.error(e);
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    // 3. RENDER FUNCTIONS (Contoh SKK, lainnya analog)
    function renderSKK(data) {
        const tbody = document.getElementById('bodySkk'); tbody.innerHTML = '';
        let expired = 0, used = 0;
        
        data.forEach((row, idx) => {
             // row[0]..row[n] sesuai array dari GAS
             // Mapping disesuaikan dengan output getDataSKK
             const nama = row[1];
             const status = row[10] || "";
             
             if(status.toLowerCase().includes('expired')) expired++;
             if(status.toLowerCase().includes('used')) used++;
             
             let btnEdit = (currentUserRole.includes('ADMIN') || currentUserRole.includes('SUPER')) ? 
                 `<button class="btn btn-sm btn-light" onclick="openModalEdit(${idx})">✏️</button>` : '';

             tbody.innerHTML += `
                <tr>
                    <td>${nama}</td>
                    <td>${row[2]||'-'}</td>
                    <td>${row[3]||''}</td>
                    <td>${row[5]||''}</td>
                    <td>${row[6]||''}</td>
                    <td>${row[9]||''}</td>
                    <td><span class="badge bg-secondary">${status}</span></td>
                    <td>${btnEdit}</td>
                </tr>`;
        });
        document.getElementById('skk-total').innerText = data.length;
        document.getElementById('skk-expired').innerText = expired;
        document.getElementById('skk-used').innerText = used;
    }
    
    // ... (Implementasi renderTugas dan renderProject serupa dengan kode asli, 
    // sesuaikan indeks array dengan output JSON dari GAS) ...

    function renderTugas(data) {
        const tbody = document.getElementById('bodyTugas'); tbody.innerHTML = '';
        data.forEach(row => {
            tbody.innerHTML += `<tr><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[9]}</td><td>${row[10]}</td><td>${row[12]}</td></tr>`;
        });
    }

    function renderProject(data) {
        const tbody = document.getElementById('bodyProject'); tbody.innerHTML = '';
        data.forEach(row => {
            tbody.innerHTML += `<tr><td>${row[2]}</td><td>${row[4]}</td><td>${row[9]||row[13]}</td><td>${row[16]}</td></tr>`;
        });
    }

    // 4. SUBMIT DATA
    async function submitForm() {
        const form = document.getElementById('formInputData');
        if (!form.checkValidity()) { form.reportValidity(); return; }
        
        const payload = {
             // Mapping ID input ke property object
             rowNumber: document.getElementById('editRowNumber').value,
             nama: document.getElementById('inputNama').value,
             perusahaan: document.getElementById('inputPerusahaan').value,
             sertifikat: document.getElementById('inputSertifikat').value,
             jenjang: document.getElementById('inputJenjang').value,
             asosiasi: document.getElementById('inputAsosiasi').value,
             masaBerlaku: document.getElementById('inputMasaBerlaku').value,
             keterangan: document.getElementById('inputKeterangan').value
        };

        // Minta password konfirmasi via Swal (SweetAlert)
        const { value: password } = await Swal.fire({
            title: 'Password Konfirmasi',
            input: 'password',
            showCancelButton: true
        });

        if (password) {
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                // KIRIM DATA via POST
                const res = await fetchAPI('saveData', 'POST', {
                    password: password, // Password dikirim di body JSON
                    payload: payload
                });
                
                if (res === "Sukses") {
                    Swal.fire('Berhasil', 'Data disimpan', 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalTambahData'));
                    modal.hide();
                    loadAllData();
                } else {
                    Swal.fire('Gagal', res, 'error');
                }
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
    }

    // 5. HELPER LAIN
    async function loadDropdowns() {
        const data = await fetchAPI('getDropdownData');
        populateDL('listNama', data.nama);
        populateDL('listPerusahaan', data.perusahaan);
        populateDL('listSertifikat', data.sertifikat);
        populateDL('listJenjang', data.jenjang);
    }
    function populateDL(id, arr) { document.getElementById(id).innerHTML = arr.map(x => `<option value="${x}">`).join(''); }
    
    function switchView(v) {
        document.querySelectorAll('.view-section').forEach(el=>el.style.display='none');
        document.getElementById('view-'+v).style.display='block';
        document.querySelectorAll('.nav-link').forEach(el=>el.classList.remove('active'));
        document.getElementById('nav-'+v).querySelector('button').classList.add('active');
    }
    
    function switchTugasSubView(v) {
         document.getElementById('subview-tugas-table').style.display = v==='table'?'block':'none';
         document.getElementById('subview-tugas-gantt').style.display = v==='gantt'?'block':'none';
         if(v==='gantt') drawGanttChart(dataTugas, 'chart_penugasan'); // Perlu fungsi drawGanttChart (sesuaikan dgn kode lama)
    }

    // ... (Fungsi Modal Add/Edit sama seperti kode asli, hanya panggil submitForm baru) ...
    const myModal = new bootstrap.Modal(document.getElementById('modalTambahData'));
    function openModalAdd() { document.getElementById('formInputData').reset(); myModal.show(); }
    function openModalEdit(idx) { 
        const item = dataSKK[idx];
        document.getElementById('inputNama').value = item[1];
        // ... set value lainnya ...
        document.getElementById('editRowNumber').value = item[item.length-1];
        myModal.show(); 
    }
    
    // Placeholder function untuk Gantt (Gunakan library Google Charts seperti di kode lama Anda)
    function drawGanttChart(data, containerId) {
        // Implementasi Google Charts Gantt sama persis dengan kode lama
        // Hanya pastikan 'data' yang masuk sudah array object yang benar
        console.log("Draw gantt for", containerId); 
    }
  </script>
</body>
</html>
